<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Premier League Prediction Game</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import {
      getFirestore, doc, setDoc, getDoc, collection, getDocs, updateDoc
    } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyA2WG0LUwLCDqmylgezCZ0aH5Q8vTaXTKU",
      authDomain: "pl-predictor-13a6d.firebaseapp.com",
      projectId: "pl-predictor-13a6d",
      storageBucket: "pl-predictor-13a6d.appspot.com",
      messagingSenderId: "286908896536",
      appId: "1:286908896536:web:dabd76b4faaa72a98cfa6d"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    async function saveData(collectionName, docId, data) {
      await setDoc(doc(db, collectionName, docId), data);
    }

    async function updateData(collectionName, docId, data) {
      await updateDoc(doc(db, collectionName, docId), data);
    }

    async function getData(collectionName, docId) {
      const ref = doc(db, collectionName, docId);
      const snap = await getDoc(ref);
      return snap.exists() ? snap.data() : null;
    }

    async function getAllDocs(collectionName) {
      const snap = await getDocs(collection(db, collectionName));
      return snap.docs.map(doc => ({ id: doc.id, data: doc.data() }));
    }

    window.firebaseHelpers = {
      saveData,
      updateData,
      getData,
      getAllDocs
    };
  </script>
</head>
<body class="bg-gray-100 text-gray-900 p-4">
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    async function saveData(collectionName, docId, data) {
      await setDoc(doc(db, collectionName, docId), data);
    }

    async function updateData(collectionName, docId, data) {
      await updateDoc(doc(db, collectionName, docId), data);
    }

    async function getData(collectionName, docId) {
      const ref = doc(db, collectionName, docId);
      const snap = await getDoc(ref);
      return snap.exists() ? snap.data() : null;
    }

    async function getAllDocs(collectionName) {
      const snap = await getDocs(collection(db, collectionName));
      return snap.docs.map(doc => ({ id: doc.id, data: doc.data() }));
    }

    window.firebaseHelpers = {
      saveData,
      getData,
      getAllDocs,
      updateData
    };

    window.getFixtures = async function(gw) {
      const data = await firebaseHelpers.getData("fixtures", `gw_${gw}`);
      return data ? data.fixtures : [];
    }

    window.saveFixtures = async function(gw, fixtures) {
      await firebaseHelpers.saveData("fixtures", `gw_${gw}`, { fixtures });
    }

    window.getPredictions = async function(gw, player) {
      const data = await firebaseHelpers.getData("predictions", `gw_${gw}_${player}`);
      return data ? data.predictions : [];
    }

    window.savePredictions = async function(gw, player, preds) {
      await firebaseHelpers.saveData("predictions", `gw_${gw}_${player}`, { predictions: preds });
    }

    window.getResults = async function(gw) {
      const data = await firebaseHelpers.getData("results", `gw_${gw}`);
      return data ? data.results : [];
    }

    window.saveResults = async function(gw, results) {
      await firebaseHelpers.saveData("results", `gw_${gw}`, { results });
    }

    window.getDeadline = async function(gw) {
      const data = await firebaseHelpers.getData("deadlines", `gw_${gw}`);
      return data ? data.deadline : "";
    }

    window.saveDeadline = async function(gw, dateStr) {
      await firebaseHelpers.saveData("deadlines", `gw_${gw}`, { deadline: dateStr });
    }

    window.getPassword = async function(player) {
      const data = await firebaseHelpers.getData("passwords", player);
      return data ? data.password : null;
    }

    window.savePassword = async function(player, pw) {
      await firebaseHelpers.saveData("passwords", player, { password: pw });
    }
  </script>
</head>
<body class="bg-gray-100 p-4 text-gray-900">

<div id="loginPage" class="max-w-md mx-auto mt-20 bg-white p-6 rounded shadow">
  <h1 class="text-2xl font-bold mb-6 text-center">Login to Prediction Game</h1>
  <form id="loginForm" class="flex flex-col gap-4">
    <label for="loginPlayer" class="font-semibold">Select Player:</label>
    <select id="loginPlayer" required class="p-2 border rounded">
      <option value="" disabled selected>Choose player</option>
      <option value="david">David</option>
      <option value="katja">Katja</option>
      <option value="mark">Mark</option>
      <option value="jus">Jus</option>
    </select>

    <label for="loginPassword" class="font-semibold">Enter Password:</label>
    <input type="password" id="loginPassword" required placeholder="Enter password" class="p-2 border rounded" />

    <button type="submit" class="bg-blue-600 text-white py-2 rounded hover:bg-blue-700">Login</button>
  </form>
  <p id="loginMsg" class="text-red-600 mt-3 text-center"></p>

  <button id="showResetBtn" class="mt-4 text-sm text-blue-700 underline hover:text-blue-900">Forgot or Reset Password?</button>

  <form id="resetForm" class="flex flex-col gap-3 mt-4 hidden">
    <h2 class="text-lg font-semibold text-center mb-2">Password Reset</h2>

    <label for="resetPlayer" class="font-semibold">Select Player:</label>
    <select id="resetPlayer" required class="p-2 border rounded">
      <option value="" disabled selected>Choose player</option>
      <option value="david">David</option>
      <option value="katja">Katja</option>
      <option value="mark">Mark</option>
      <option value="jus">Jus</option>
    </select>

    <label for="currentPassword" class="font-semibold">Current Password:</label>
    <input type="password" id="currentPassword" placeholder="Current password" class="p-2 border rounded" required />

    <label for="newPassword" class="font-semibold">New Password:</label>
    <input type="password" id="newPassword" placeholder="New password" class="p-2 border rounded" required />

    <label for="confirmPassword" class="font-semibold">Confirm New Password:</label>
    <input type="password" id="confirmPassword" placeholder="Confirm new password" class="p-2 border rounded" required />

    <button type="submit" class="bg-green-600 text-white py-2 rounded hover:bg-green-700">Reset Password</button>
    <button type="button" id="cancelResetBtn" class="mt-2 text-center text-red-600 underline hover:text-red-800">Cancel</button>
    <p id="resetMsg" class="text-red-600 mt-2 text-center"></p>
  </form>
</div>

<div id="gamePage" class="max-w-4xl mx-auto hidden">
  <div class="flex justify-between items-center mb-4">
    <h1 class="text-2xl font-bold">Premier League Prediction Game</h1>
    <button id="logoutBtn" class="bg-red-600 text-white px-3 py-1 rounded hover:bg-red-700">Logout</button>
  </div>

  <!-- Gameweek Navigation -->
  <div class="mb-4">
    <label for="gameWeek" class="font-semibold">Game Week:</label>
    <select id="gameWeek" class="ml-2 p-1 border rounded">
      <!-- JS will populate this -->
    </select>
  </div>

  <!-- Deadline -->
  <div class="mb-4">
    <label class="font-semibold">Deadline:</label>
    <span id="deadlineDisplay" class="ml-2"></span>
    <input type="date" id="deadlineInput" class="ml-2 p-1 border rounded hidden" />
    <button id="saveDeadlineBtn" class="ml-2 bg-blue-600 text-white px-3 py-1 rounded hidden">Save Deadline</button>
  </div>

  <!-- Fixtures Input (David only) -->
  <div class="mb-6" id="fixturesSection">
    <h2 class="text-xl font-semibold mb-2">Fixtures</h2>
    <button id="addFixture" class="mb-2 bg-blue-500 text-white px-2 py-1 rounded hidden">Add Fixture</button>
    <div id="fixtures"></div>
  </div>

  <!-- Predictions Section -->
  <div class="mb-6">
    <h2 class="text-xl font-semibold mb-2">Your Predictions</h2>
    <div id="predictions"></div>
  </div>

  <button id="submitPredictions" class="mb-6 bg-green-500 text-white px-4 py-2 rounded">Submit Predictions</button>

  <!-- Results Input -->
  <div class="mb-6">
    <h2 class="text-xl font-semibold mb-2">Actual Results</h2>
    <div id="results"></div>
    <button id="submitResults" class="mt-2 bg-purple-500 text-white px-4 py-2 rounded hidden">Submit Results</button>
  </div>

  <!-- Points per Fixture -->
  <div class="mb-6">
    <h2 class="text-xl font-semibold mb-2">Points per Fixture</h2>
    <div id="pointsPerFixture"></div>
  </div>

  <!-- Leaderboards -->
  <div class="mb-6">
    <h2 class="text-xl font-semibold mb-2">Weekly Leaderboard</h2>
    <div id="weeklyLeaderboard" class="bg-white p-4 rounded shadow mb-4"></div>

    <h2 class="text-xl font-semibold mb-2">Overall Leaderboard</h2>
    <div id="leaderboard" class="bg-white p-4 rounded shadow"></div>
  </div>

  <!-- Export/Import (David only) -->
  <div id="dataBackup" class="mb-6 hidden">
    <h2 class="text-xl font-semibold mb-2">Data Backup (David only)</h2>
    <button id="exportDataBtn" class="bg-yellow-500 text-black px-4 py-2 rounded mr-4">Export Data</button>
    <input type="file" id="importDataInput" accept=".json" class="hidden" />
    <button id="importDataBtn" class="bg-yellow-500 text-black px-4 py-2 rounded">Import Data</button>
  </div>
</div>
  submitResultsBtn.addEventListener("click", async () => {
    if (currentPlayer !== "david") return alert("Only David can submit results.");
    if (!currentWeek) return alert("Select a game week.");
    const fixtures = await getFixtures(currentWeek);
    if (fixtures.length === 0) return alert("Add fixtures first.");

    let results = [];

    for (let i = 0; i < fixtures.length; i++) {
      const homeInput = document.getElementById(`res_home_${i}`);
      const awayInput = document.getElementById(`res_away_${i}`);
      if (!homeInput || !awayInput) continue;

      const homeVal = homeInput.value;
      const awayVal = awayInput.value;

      if (homeVal === "" && awayVal === "") continue;

      const homeNum = parseInt(homeVal);
      const awayNum = parseInt(awayVal);

      if (isNaN(homeNum) || isNaN(awayNum)) {
        alert("Please enter valid numbers for results.");
        return;
      }

      results[i] = { home: homeNum, away: awayNum };
    }

    await saveResults(currentWeek, results);
    alert("Results saved!");
    renderAll();
  });

  // Deadline save
  saveDeadlineBtn.addEventListener("click", async () => {
    if (currentPlayer !== "david") return;
    if (!currentWeek || !deadlineInput.value) return;
    await saveDeadline(currentWeek, deadlineInput.value);
    alert("Deadline saved.");
    renderDeadline();
  });

  // Password reset form
  resetForm.addEventListener("submit", async (e) => {
    e.preventDefault();
    const player = resetPlayer.value;
    const curPw = currentPassword.value.trim();
    const newPwVal = newPassword.value.trim();
    const confirmPw = confirmPassword.value.trim();

    if (!players.includes(player)) {
      resetMsg.textContent = "Invalid player selected.";
      return;
    }
    if (!curPw || !newPwVal || !confirmPw) {
      resetMsg.textContent = "Please fill all fields.";
      return;
    }
    if (newPwVal !== confirmPw) {
      resetMsg.textContent = "New passwords do not match.";
      return;
    }

    const storedPw = await getPassword(player);
    if (storedPw === null || storedPw !== curPw) {
      resetMsg.textContent = "Current password is incorrect.";
      return;
    }

    await savePassword(player, newPwVal);
    resetMsg.style.color = "green";
    resetMsg.textContent = "Password reset successful! You can now login.";
  });
  // Handle login form submit
  loginForm.addEventListener("submit", async e => {
    e.preventDefault();
    const player = loginPlayer.value;
    const pwEntered = loginPassword.value.trim();

    if (!players.includes(player)) {
      loginMsg.textContent = "Invalid player selected.";
      return;
    }
    if (!pwEntered) {
      loginMsg.textContent = "Password cannot be empty.";
      return;
    }

    const storedPw = await getPassword(player);

    if (storedPw === null) {
      // No password yet, save it now
      await savePassword(player, pwEntered);
      loginMsg.textContent = "";
      loginSuccess(player);
    } else {
      // Check password
      if (storedPw === pwEntered) {
        loginMsg.textContent = "";
        loginSuccess(player);
      } else {
        loginMsg.textContent = "Incorrect password.";
      }
    }
  });

  // Password reset toggle
  showResetBtn.addEventListener("click", () => {
    resetForm.classList.toggle("hidden");
    loginMsg.textContent = "";
    resetMsg.textContent = "";
  });

  cancelResetBtn.addEventListener("click", () => {
    resetForm.classList.add("hidden");
    resetMsg.textContent = "";
  });

  resetForm.addEventListener("submit", async e => {
    e.preventDefault();
    const player = resetPlayer.value;
    const curPw = currentPassword.value.trim();
    const newPwVal = newPassword.value.trim();
    const confirmPw = confirmPassword.value.trim();

    if (!players.includes(player)) {
      resetMsg.textContent = "Invalid player selected.";
      return;
    }
    if (!curPw || !newPwVal || !confirmPw) {
      resetMsg.textContent = "Please fill all fields.";
      return;
    }
    if (newPwVal !== confirmPw) {
      resetMsg.textContent = "New passwords do not match.";
      return;
    }

    const storedPw = await getPassword(player);
    if (storedPw === null) {
      resetMsg.textContent = "Player has no password set yet.";
      return;
    }

    if (storedPw !== curPw) {
      resetMsg.textContent = "Current password is incorrect.";
      return;
    }

    await savePassword(player, newPwVal);
    resetMsg.style.color = "green";
    resetMsg.textContent = "Password reset successful! You can now login.";
    // Clear fields
    currentPassword.value = "";
    newPassword.value = "";
    confirmPassword.value = "";
  });

  // Successful login
  async function loginSuccess(player) {
    currentPlayer = player;
    // Determine last active gameweek for player
    currentWeek = 1;
    for (let gw = totalGameWeeks; gw >= 1; gw--) {
      const preds = await getPredictions(gw, player);
      const res = await getResults(gw);
      const fx = await getFixtures(gw);
      if (preds.length > 0 || res.length > 0 || (fx.length > 0 && player === "david")) {
        currentWeek = gw;
        break;
      }
    }
    gwSelect.value = currentWeek;
    loginPage.classList.add("hidden");
    gamePage.classList.remove("hidden");
    updateControlsVisibility();
    await renderAll();
  }
});
</script>

</body>
</html>
