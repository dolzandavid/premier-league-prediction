<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Premier League Predictor</title>
  <script type="module" src="="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
  <script type="module" src="="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
  <style>
    input[type="number"]::-webkit-inner-spin-button,
    input[type="number"]::-webkit-outer-spin-button {
      opacity: 1;
    }
  </style>
</head>
<body class="bg-gray-100 text-gray-800">
  <div class="max-w-5xl mx-auto p-4">
    <h1 class="text-2xl font-bold mb-4 text-center">Premier League Prediction Game</h1>

    <!-- LOGIN SECTION -->
    <div id="loginSection" class="mb-6">
      <select id="username" class="border p-2 mr-2">
        <option value="" disabled selected>Select player</option>
        <option value="david">David</option>
        <option value="katja">Katja</option>
        <option value="mark">Mark</option>
        <option value="jus">Jus</option>
      </select>
      <input id="password" type="password" class="border p-2 mr-2" placeholder="Password" />
      <button id="loginBtn" class="bg-blue-500 text-white px-4 py-2">Login</button>
      <button id="changePasswordBtn" class="text-sm text-blue-600 underline ml-4">Change password</button>
    </div>

    <!-- APP UI -->
    <div id="app" style="display:none;">
      <div class="flex justify-between items-center mb-4">
        <span id="welcomeUser" class="font-semibold"></span>
        <button id="logoutBtn" class="bg-gray-400 text-white px-3 py-1 rounded">Logout</button>
      </div>

      <!-- Gameweek Picker -->
      <div class="mb-4">
        <label for="gameweekSelect" class="mr-2 font-medium">Gameweek:</label>
        <select id="gameweekSelect" class="border p-2"></select>
        <span id="gameweekDeadline" class="ml-4 text-sm text-gray-600"></span>
      </div>

      <!-- Fixture Editor (David only) -->
      <div id="fixtureEditor" class="mb-6 hidden">
        <h2 class="text-lg font-semibold mb-2">Edit Fixtures</h2>
        <input id="newHomeTeam" class="border p-2 mr-2" placeholder="Home Team" />
        <input id="newAwayTeam" class="border p-2 mr-2" placeholder="Away Team" />
        <button id="addFixtureBtn" class="bg-green-500 text-white px-3 py-1">Add Fixture</button>
        <div class="mt-2">
          <label class="text-sm">Deadline:</label>
          <input type="datetime-local" id="deadlineInput" class="border p-1 ml-2" />
          <button id="setDeadlineBtn" class="bg-blue-500 text-white px-2 py-1 ml-2 text-sm">Set Deadline</button>
        </div>
      </div>

      <!-- Fixtures Container -->
      <div id="fixturesContainer" class="mb-8"></div>

      <!-- Leaderboards -->
      <div class="mb-6">
        <h2 class="text-lg font-semibold mb-2">Overall Leaderboard</h2>
        <div id="leaderboardOverall" class="overflow-x-auto"></div>

        <h2 class="text-lg font-semibold mt-6 mb-2">Weekly Leaderboard</h2>
        <div id="leaderboardWeekly" class="overflow-x-auto"></div>
      </div>

      <!-- Password Reset Section (David only) -->
      <div id="passwordResetSection" class="hidden mb-8">
        <h2 class="text-lg font-semibold mb-2">Reset Player Password</h2>
        <select id="resetUserSelect" class="border p-2 mr-2"></select>
        <input id="newPasswordInput" class="border p-2 mr-2" placeholder="New Password" />
        <button id="resetPasswordBtn" class="bg-red-500 text-white px-3 py-1">Reset Password</button>
      </div>
    </div> <!-- end #app -->
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
  import { getFirestore, doc, setDoc, getDoc, getDocs, deleteDoc, collection } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyA2WG0LUwLCDqmylgezCZ0aH5Q8vTaXTKU",
      authDomain: "pl-predictor-13a6d.firebaseapp.com",
      projectId: "pl-predictor-13a6d",
      storageBucket: "pl-predictor-13a6d.appspot.com",
      messagingSenderId: "286908896536",
      appId: "1:286908896536:web:dabd76b4faaa72a98cfa6d"
    };

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);

  const users = ["david", "katja", "mark", "jus"];
  let currentUser = "";
  let currentGameweek = "";

  const capitalize = name => name.charAt(0).toUpperCase() + name.slice(1);

  document.getElementById("loginBtn").onclick = async () => {
    const user = document.getElementById("username").value;
    const pass = document.getElementById("password").value;
    const passSnap = await getDoc(doc(db, "passwords", user));
    if (!passSnap.exists() || passSnap.data().password !== pass) {
      alert("Invalid password");
      return;
    }

    currentUser = user;
    document.getElementById("loginSection").style.display = "none";
    document.getElementById("app").style.display = "block";
    document.getElementById("welcomeUser").textContent = `Welcome, ${capitalize(user)}`;

    if (user === "david") {
      document.getElementById("fixtureEditor").classList.remove("hidden");
      document.getElementById("passwordResetSection").classList.remove("hidden");
      document.getElementById("resetUserSelect").innerHTML = users.map(u =>
        `<option value="${u}">${capitalize(u)}</option>`).join("");
    }

    await autoSelectGameweek();
    await loadGameweekData();
  };

  async function autoSelectGameweek() {
    const snapshot = await getDocs(collection(db, "deadlines"));
    const now = new Date();
    let closest = null;
    let minDiff = Infinity;
    snapshot.forEach(doc => {
      const d = new Date(doc.data().deadline);
      const diff = Math.abs(d - now);
      if (diff < minDiff) {
        minDiff = diff;
        closest = doc.id;
      }
    });
    const week = closest || "1";
    currentGameweek = week;
    await loadGameweekOptions(week);
  }

  async function loadGameweekOptions(selected) {
    const snapshot = await getDocs(collection(db, "fixtures"));
    const weeks = [...new Set(snapshot.docs.map(d => d.id.split("_")[0]))].sort((a, b) => +a - +b);
    document.getElementById("gameweekSelect").innerHTML = weeks.map(w =>
      `<option value="${w}">Gameweek ${w}</option>`).join("");
    document.getElementById("gameweekSelect").value = selected;
  }

  document.getElementById("gameweekSelect").onchange = async (e) => {
    currentGameweek = e.target.value;
    await loadGameweekData();
  };

  document.getElementById("logoutBtn").onclick = () => location.reload();

  document.getElementById("changePasswordBtn").onclick = async () => {
    const user = document.getElementById("username").value;
    const newPass = prompt("Enter new password:");
    if (!user || !newPass) return;
    await setDoc(doc(db, "passwords", user), { password: newPass });
    alert("Password changed!");
  };

  document.getElementById("resetPasswordBtn").onclick = async () => {
    const user = document.getElementById("resetUserSelect").value;
    const newPass = document.getElementById("newPasswordInput").value;
    if (!newPass) return;
    await setDoc(doc(db, "passwords", user), { password: newPass });
    alert("Password reset.");
  };

  document.getElementById("addFixtureBtn").onclick = async () => {
    const home = document.getElementById("newHomeTeam").value.trim();
    const away = document.getElementById("newAwayTeam").value.trim();
    if (!home || !away) return;
    const id = `${currentGameweek}_${home}_${away}_${Date.now()}`;
    await setDoc(doc(db, "fixtures", id), { home, away });
    await loadGameweekData();
  };

  document.getElementById("setDeadlineBtn").onclick = async () => {
    const dt = document.getElementById("deadlineInput").value;
    if (!dt) return;
    await setDoc(doc(db, "deadlines", currentGameweek), { deadline: dt });
    await loadGameweekData();
  };

  async function loadGameweekData() {
    const container = document.getElementById("fixturesContainer");
    const results = (await getDoc(doc(db, "results", currentGameweek))).data() || {};
    const predictions = (await getDoc(doc(db, "predictions", currentGameweek))).data() || {};
    const deadlines = (await getDoc(doc(db, "deadlines", currentGameweek))).data();
    const fixtureDocs = await getDocs(collection(db, "fixtures"));
    const fixtures = fixtureDocs.docs.filter(d => d.id.startsWith(currentGameweek + "_")).map(d => ({ id: d.id, ...d.data() }));

    container.innerHTML = "";
    document.getElementById("gameweekDeadline").textContent = deadlines ? `Deadline: ${new Date(deadlines.deadline).toLocaleString()}` : "";

    for (let fixture of fixtures) {
      const div = document.createElement("div");
      div.className = "border p-3 my-2 bg-white rounded shadow";

      const fid = fixture.id;
      const pred = predictions[fid]?.[currentUser];
      const res = results[fid];
      const isLocked = !!res;

      const home = fixture.home;
      const away = fixture.away;
      div.innerHTML = `
        <div class="font-semibold">${home} vs ${away}</div>
        <div class="mt-2 flex space-x-4">
          <div>
            <label class="text-sm block">Your Prediction:</label>
            <input type="number" min="0" class="border p-1 w-12 predHome" value="${pred?.home ?? ''}" ${isLocked ? 'disabled' : ''}>
            :
            <input type="number" min="0" class="border p-1 w-12 predAway" value="${pred?.away ?? ''}" ${isLocked ? 'disabled' : ''}>
            ${!isLocked ? `<button class="savePred text-blue-600 text-sm ml-2">Save</button>` : ""}
            ${pred && !isLocked ? `<button class="deletePred text-red-500 text-sm ml-2">Delete</button>` : ""}
          </div>
          <div>
            <label class="text-sm block">Result:</label>
            ${
              currentUser === "david" || res
              ? `
                <input type="number" min="0" class="border p-1 w-12 resHome" value="${res?.home ?? ''}" ${currentUser !== "david" ? 'disabled' : ''}>
                :
                <input type="number" min="0" class="border p-1 w-12 resAway" value="${res?.away ?? ''}" ${currentUser !== "david" ? 'disabled' : ''}>
                ${currentUser === "david" ? `<button class="saveRes text-green-600 text-sm ml-2">Save</button>` : ""}
              `
              : currentUser === "david"
              ? `<span class="text-sm text-gray-500">Enter result</span>`
              : ""
            }
          </div>
        </div>
        <div class="text-sm mt-2 playersPredictions"></div>
      `;
      container.appendChild(div);

      // Save prediction
      div.querySelector(".savePred")?.onclick = async () => {
        const h = div.querySelector(".predHome").value;
        const a = div.querySelector(".predAway").value;
        const snap = await getDoc(doc(db, "predictions", currentGameweek));
        const data = snap.exists() ? snap.data() : {};
        if (!data[fid]) data[fid] = {};
        data[fid][currentUser] = { home: +h, away: +a };
        await setDoc(doc(db, "predictions", currentGameweek), data);
        loadGameweekData();
      };

      // Delete prediction
      div.querySelector(".deletePred")?.onclick = async () => {
        const snap = await getDoc(doc(db, "predictions", currentGameweek));
        const data = snap.exists() ? snap.data() : {};
        if (data[fid]) {
          delete data[fid][currentUser];
          if (Object.keys(data[fid]).length === 0) delete data[fid];
        }
        await setDoc(doc(db, "predictions", currentGameweek), data);
        loadGameweekData();
      };

      // Save result
      div.querySelector(".saveRes")?.onclick = async () => {
        const h = div.querySelector(".resHome").value;
        const a = div.querySelector(".resAway").value;
        const snap = await getDoc(doc(db, "results", currentGameweek));
        const data = snap.exists() ? snap.data() : {};
        data[fid] = { home: +h, away: +a };
        await setDoc(doc(db, "results", currentGameweek), data);
        loadGameweekData();
      };

      // Show all predictions only after current user submits
      const all = predictions[fid] || {};
      if (pred) {
        div.querySelector(".playersPredictions").innerHTML = Object.entries(all)
          .map(([u, p]) => `${capitalize(u)}: ${p.home}:${p.away}${res ? ` (${calcPoints(p, res)} pts)` : ""}`)
          .join("<br>");
      }
    }

    renderLeaderboards(predictions, results, fixtures);
  }

  function calcPoints(pred, res) {
    let pts = 0;
    if (pred.home === res.home) pts++;
    if (pred.away === res.away) pts++;
    if (Math.sign(pred.home - pred.away) === Math.sign(res.home - res.away)) pts += 2;
    if (pred.home === res.home && pred.away === res.away) pts++;
    return pts;
  }

  function renderLeaderboards(predictions, results, fixtures) {
    const total = {}, weekly = {};
    for (let f of fixtures) {
      const fid = f.id;
      const res = results[fid];
      if (!res) continue;
      const predSet = predictions[fid] || {};
      for (let user in predSet) {
        const pts = calcPoints(predSet[user], res);
        total[user] = (total[user] || 0) + pts;
        weekly[user] = (weekly[user] || 0) + pts;
      }
    }

    const toTable = obj => `<table class="w-full text-sm border">
      <thead><tr><th class="border px-2">Player</th><th class="border px-2">Points</th></tr></thead>
      <tbody>${Object.entries(obj).sort((a,b)=>b[1]-a[1]).map(([u,p]) =>
        `<tr><td class="border px-2">${capitalize(u)}</td><td class="border px-2">${p}</td></tr>`).join("")}</tbody>
    </table>`;

    document.getElementById("leaderboardOverall").innerHTML = toTable(total);
    document.getElementById("leaderboardWeekly").innerHTML = toTable(weekly);
  }
</script>
</body>
</html>
