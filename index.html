<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Premier League Prediction Game</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 p-6 text-gray-800">
  <div class="max-w-3xl mx-auto bg-white p-6 rounded shadow">
    <h1 class="text-2xl font-bold mb-4">Premier League Prediction Game</h1>

    <div class="grid grid-cols-2 gap-4 mb-6">
      <div>
        <label class="block font-semibold mb-1" for="player">Player</label>
        <select id="player" class="w-full border p-2 rounded">
          <option value="">-- Select Player --</option>
          <option value="david">David</option>
          <option value="katja">Katja</option>
          <option value="mark">Mark</option>
          <option value="jus">Jus</option>
        </select>
      </div>
      <div>
        <label class="block font-semibold mb-1" for="week">Game Week</label>
        <select id="week" class="w-full border p-2 rounded">
          <option value="">-- Select Week --</option>
          <!-- options dynamically added -->
        </select>
      </div>
    </div>

    <div class="mb-6">
      <h2 class="text-xl font-semibold mb-2">Add Fixture</h2>
      <div id="fixtureControls" class="flex gap-2 mb-2">
        <input id="homeTeam" placeholder="Home Team" class="flex-1 border p-2 rounded" />
        <input id="awayTeam" placeholder="Away Team" class="flex-1 border p-2 rounded" />
        <button id="addFixture" class="bg-blue-500 text-white px-4 py-2 rounded">Add</button>
      </div>
      <div id="fixturesDiv" class="text-sm text-gray-600"></div>
    </div>

    <div class="mb-6">
      <h2 class="text-xl font-semibold mb-2">Your Predictions</h2>
      <div id="predictionsDiv"></div>
      <button id="submitPredictions" class="mt-2 bg-green-600 text-white px-4 py-2 rounded">Submit Predictions</button>
    </div>

    <div class="mb-6">
      <h2 class="text-xl font-semibold mb-2">Actual Results</h2>
      <div id="resultsDiv"></div>
      <button id="submitResults" class="mt-2 bg-purple-600 text-white px-4 py-2 rounded">Submit Results</button>
    </div>

    <div class="mb-6">
      <h2 class="text-xl font-semibold mb-2">Points per Fixture (after results submitted)</h2>
      <div id="pointsPerFixtureDiv" class="text-sm text-gray-700"></div>
    </div>

    <div class="mb-6">
      <h2 class="text-xl font-semibold mb-2">All Predictions</h2>
      <div id="allPredictionsDiv"></div>
    </div>

    <div class="mb-6">
      <h2 class="text-xl font-semibold mb-2">Leaderboard</h2>
      <div id="leaderboardDiv"></div>
      <div id="overallLeaderboardDiv" class="mt-4 border-t pt-4 text-gray-700"></div>
    </div>
  </div>

  <script>
    const players = ["david", "katja", "mark", "jus"];
    const playerEl = document.getElementById("player");
    const weekEl = document.getElementById("week");
    const fixturesDiv = document.getElementById("fixturesDiv");
    const predictionsDiv = document.getElementById("predictionsDiv");
    const resultsDiv = document.getElementById("resultsDiv");
    const allPredictionsDiv = document.getElementById("allPredictionsDiv");
    const leaderboardDiv = document.getElementById("leaderboardDiv");
    const overallLeaderboardDiv = document.getElementById("overallLeaderboardDiv");
    const pointsPerFixtureDiv = document.getElementById("pointsPerFixtureDiv");
    const fixtureControls = document.getElementById("fixtureControls");
    const addFixtureBtn = document.getElementById("addFixture");
    const homeInput = document.getElementById("homeTeam");
    const awayInput = document.getElementById("awayTeam");
    const submitPredictionsBtn = document.getElementById("submitPredictions");
    const submitResultsBtn = document.getElementById("submitResults");

    let currentPlayer = "";
    let currentWeek = "";

    document.addEventListener("DOMContentLoaded", () => {
      for (let i = 1; i <= 38; i++) {
        const opt = document.createElement("option");
        opt.value = i;
        opt.textContent = `Week ${i}`;
        weekEl.appendChild(opt);
      }
      updateFixtureControlsVisibility();
    });

    function safeJSON(key) {
      try { return JSON.parse(localStorage.getItem(key)); } catch { return null; }
    }

    function getFixtures(week) {
      return safeJSON(`gw_${week}_fixtures`) || [];
    }

    function saveFixtures(week, fixtures) {
      localStorage.setItem(`gw_${week}_fixtures`, JSON.stringify(fixtures));
    }

    function getResults(week) {
      return safeJSON(`gw_${week}_results`) || [];
    }

    function saveResults(week, results) {
      localStorage.setItem(`gw_${week}_results`, JSON.stringify(results));
    }

    function renderFixtures() {
      const fixtures = getFixtures(currentWeek);
      if (fixtures.length === 0) {
        fixturesDiv.textContent = "No fixtures added for this week.";
        return;
      }
      fixturesDiv.innerHTML = "";
      fixtures.forEach((f, i) => {
        const div = document.createElement("div");
        div.className = "flex justify-between items-center border-b py-1";
        div.innerHTML = `<span>${f.home} vs ${f.away}</span>`;
        if (currentPlayer === "david") {
          const delBtn = document.createElement("button");
          delBtn.textContent = "Delete";
          delBtn.className = "ml-4 bg-red-500 text-white px-2 py-1 rounded text-xs";
          delBtn.addEventListener("click", () => {
            if (confirm(`Delete fixture: ${f.home} vs ${f.away}?`)) {
              fixtures.splice(i, 1);
              saveFixtures(currentWeek, fixtures);

              // Also remove predictions for this fixture from all players
              players.forEach(p => {
                let preds = safeJSON(`gw_${currentWeek}_predictions_${p}`) || [];
                if (preds.length > i) {
                  preds.splice(i,1);
                  localStorage.setItem(`gw_${currentWeek}_predictions_${p}`, JSON.stringify(preds));
                }
              });
              // Also remove results for this fixture
              let results = getResults(currentWeek);
              if (results.length > i) {
                results.splice(i,1);
                saveResults(currentWeek, results);
              }

              renderFixtures();
              renderPredictions();
              renderResults();
              renderAllPredictions();
              renderPointsPerFixture();
              updateLeaderboard();
            }
          });
          div.appendChild(delBtn);
        }
        fixturesDiv.appendChild(div);
      });
    }

    function renderPredictions() {
      predictionsDiv.innerHTML = "";
      const fixtures = getFixtures(currentWeek);
      if (!currentPlayer || !currentWeek) {
        predictionsDiv.textContent = "Select player and week to enter predictions.";
        return;
      }
      if (fixtures.length === 0) {
        predictionsDiv.textContent = "Add fixtures first.";
        return;
      }
      const saved = safeJSON(`gw_${currentWeek}_predictions_${currentPlayer}`) || [];
      const results = getResults(currentWeek);

      fixtures.forEach((f, i) => {
        const res = results[i];
        const hasResult = res && res.home !== "" && res.away !== "";

        const pred = saved[i] || { home: "", away: "" };

        const disabled = hasResult; // disable inputs if result exists

        predictionsDiv.innerHTML += `
          <div class="flex gap-2 items-center mb-2">
            <label class="w-32">${f.home}</label>
            <input id="ph_${i}" type="number" class="w-12 border p-1 rounded" value="${pred.home}" min="0" placeholder="-" ${disabled ? "disabled" : ""} />
            <span>:</span>
            <input id="pa_${i}" type="number" class="w-12 border p-1 rounded" value="${pred.away}" min="0" placeholder="-" ${disabled ? "disabled" : ""} />
            <label class="w-32">${f.away}</label>
            ${disabled ? `<span class="ml-2 text-red-600 text-xs italic">Result submitted, prediction locked</span>` : ""}
          </div>`;
      });
    }

    function renderResults() {
      resultsDiv.innerHTML = "";
      const fixtures = getFixtures(currentWeek);
      if (fixtures.length === 0) {
        resultsDiv.textContent = "Add fixtures first.";
        return;
      }
      const saved = getResults(currentWeek);
      fixtures.forEach((f, i) => {
        const res = saved[i] || { home: "", away: "" };
        resultsDiv.innerHTML += `
          <div class="flex gap-2 items-center mb-2">
            <label class="w-32">${f.home}</label>
            <input id="rh_${i}" type="number" class="w-12 border p-1 rounded" value="${res.home}" min="0" placeholder="-" />
            <span>:</span>
            <input id="ra_${i}" type="number" class="w-12 border p-1 rounded" value="${res.away}" min="0" placeholder="-" />
            <label class="w-32">${f.away}</label>
            ${currentPlayer === "david" && (res.home !== "" || res.away !== "") ? `<button data-index="${i}" class="deleteResultBtn ml-4 bg-red-600 text-white text-xs rounded px-2 py-1">Delete Result</button>` : ""}
          </div>`;
      });

      // Add event listeners for delete result buttons
      setTimeout(() => {
        document.querySelectorAll(".deleteResultBtn").forEach(btn => {
          btn.onclick = (e) => {
            const idx = parseInt(e.target.getAttribute("data-index"), 10);
            if (confirm("Delete result for this fixture?")) {
              const results = getResults(currentWeek);
              if (results.length > idx) {
                results.splice(idx, 1);
                saveResults(currentWeek, results);
                renderResults();
                renderPredictions();
                renderPointsPerFixture();
                updateLeaderboard();
              }
            }
          };
        });
      }, 50);
    }

    function renderAllPredictions() {
      allPredictionsDiv.innerHTML = "";
      const fixtures = getFixtures(currentWeek);
      if (fixtures.length === 0) {
        allPredictionsDiv.textContent = "No fixtures added.";
        return;
      }
      players.forEach(p => {
        const saved = safeJSON(`gw_${currentWeek}_predictions_${p}`) || [];
        if (!saved.length) return;
        let html = `<h3 class="capitalize font-semibold mt-4">${p}</h3>`;
        saved.forEach((s, i) => {
          html += `<div>${fixtures[i].home} ${s.home !== "" ? s.home : "-"}:${s.away !== "" ? s.away : "-"} ${fixtures[i].away}</div>`;
        });
        allPredictionsDiv.innerHTML += html;
      });
    }

    function calculatePoints(pred, actual) {
      if (pred.home === "" || pred.away === "") return 0; // no prediction = 0 pts
      let points = 0;
      if (pred.home === actual.home) points++;
      if (pred.away === actual.away) points++;
      const predDiff = pred.home - pred.away;
      const actualDiff = actual.home - actual.away;
      if ((predDiff === 0 && actualDiff === 0) || (predDiff * actualDiff > 0)) points += 2;
      if (pred.home === actual.home && pred.away === actual.away) points++;
      return points;
    }

    function renderPointsPerFixture() {
      pointsPerFixtureDiv.innerHTML = "";
      const fixtures = getFixtures(currentWeek);
      const results = getResults(currentWeek);
      if (fixtures.length === 0 || results.length === 0) {
        pointsPerFixtureDiv.textContent = "Add fixtures and results to see points per fixture.";
        return;
      }
      let html = "<table class='w-full border border-collapse text-sm'><thead><tr><th class='border px-2 py-1'>Player</th>";
      fixtures.forEach((f, i) => {
        html += `<th class="border px-2 py-1">${f.home} vs ${f.away}</th>`;
      });
      html += "</tr></thead><tbody>";
      players.forEach(p => {
        const preds = safeJSON(`gw_${currentWeek}_predictions_${p}`) || [];
        html += `<tr><td class="border px-2 py-1 capitalize font-semibold">${p}</td>`;
        fixtures.forEach((_, i) => {
          if (preds[i] && results[i]) {
            const pts = calculatePoints(preds[i], results[i]);
            html += `<td class="border px-2 py-1 text-center">${pts}</td>`;
          } else {
            html += `<td class="border px-2 py-1 text-center">-</td>`;
          }
        });
        html += "</tr>";
      });
      html += "</tbody></table>";
      pointsPerFixtureDiv.innerHTML = html;
    }

    function updateLeaderboard() {
      leaderboardDiv.innerHTML = "";
      const fixtures = getFixtures(currentWeek);
      const results = getResults(currentWeek);
      if (fixtures.length === 0 || results.length === 0) {
        leaderboardDiv.textContent = "Add fixtures and results to see leaderboard.";
      } else {
        const scores = {};
        players.forEach(p => { scores[p] = 0; });
        players.forEach(p => {
          const saved = safeJSON(`gw_${currentWeek}_predictions_${p}`) || [];
          saved.forEach((s, i) => {
            const r = results[i];
            if (!r) return;
            scores[p] += calculatePoints(s, r);
          });
        });
        const sorted = Object.entries(scores).sort((a,b) => b[1] - a[1]);
        let html = `<h3 class='font-semibold mb-2'>Leaderboard for Week ${currentWeek}</h3>`;
        sorted.forEach(([p, s]) => {
          html += `<div class="capitalize font-semibold">${p}: ${s} pts</div>`;
        });
        leaderboardDiv.innerHTML = html;
      }

      // Overall leaderboard
      const overallScores = {};
      players.forEach(p => overallScores[p] = 0);
      for(let w=1; w<=38; w++) {
        const weekFixtures = getFixtures(w);
        const weekResults = getResults(w);
        if (weekFixtures.length === 0 || weekResults.length === 0) continue;
        players.forEach(p => {
          const weekPreds = safeJSON(`gw_${w}_predictions_${p}`) || [];
          weekPreds.forEach((pred, i) => {
            const actual = weekResults[i];
            if (!actual) return;
            overallScores[p] += calculatePoints(pred, actual);
          });
        });
      }
      const sortedOverall = Object.entries(overallScores).sort((a,b) => b[1] - a[1]);
      let overallHtml = "<h3 class='font-semibold mb-2'>Overall Leaderboard</h3>";
      sortedOverall.forEach(([p, s]) => {
        overallHtml += `<div class="capitalize font-semibold">${p}: ${s} pts</div>`;
      });
      overallLeaderboardDiv.innerHTML = overallHtml;
    }

    function updateFixtureControlsVisibility() {
      // Only David sees fixture controls & results submit button
      fixtureControls.style.display = currentPlayer === "david" ? "flex" : "none";
      submitResultsBtn.style.display = currentPlayer === "david" ? "inline-block" : "none";
    }

    function handleChange() {
      currentPlayer = playerEl.value;
      currentWeek = weekEl.value;
      updateFixtureControlsVisibility();

      if (!currentPlayer || !currentWeek) {
        fixturesDiv.textContent = "Select player and week.";
        predictionsDiv.textContent = "";
        resultsDiv.textContent = "";
        allPredictionsDiv.textContent = "";
        pointsPerFixtureDiv.textContent = "";
        leaderboardDiv.textContent = "";
        overallLeaderboardDiv.textContent = "";
        return;
      }
      renderFixtures();
      renderPredictions();
      renderResults();
      renderAllPredictions();
      renderPointsPerFixture();
      updateLeaderboard();
    }

    playerEl.addEventListener("change", handleChange);
    weekEl.addEventListener("change", handleChange);

    addFixtureBtn.addEventListener("click", () => {
      if (!currentWeek) {
        alert("Please select a game week first.");
        return;
      }
      if (currentPlayer !== "david") {
        alert("Only David can add fixtures.");
        return;
      }
      const home = homeInput.value.trim();
      const away = awayInput.value.trim();
      if (!home || !away) {
        alert("Please enter both Home and Away team names.");
        return;
      }
      const fixtures = getFixtures(currentWeek);
      fixtures.push({ home, away });
      saveFixtures(currentWeek, fixtures);
      homeInput.value = "";
      awayInput.value = "";
      renderFixtures();
      renderPredictions();
      renderResults();
      renderAllPredictions();
      renderPointsPerFixture();
      updateLeaderboard();
    });

    submitPredictionsBtn.addEventListener("click", () => {
      if (!currentPlayer || !currentWeek) {
        alert("Please select a player and game week first.");
        return;
      }
      const fixtures = getFixtures(currentWeek);
      if (fixtures.length === 0) {
        alert("Please add fixtures first.");
        return;
      }
      const results = getResults(currentWeek);
      const savedPreds = safeJSON(`gw_${currentWeek}_predictions_${currentPlayer}`) || [];

      const newPreds = [];

      for(let i=0; i < fixtures.length; i++) {
        const homeInput = document.getElementById(`ph_${i}`);
        const awayInput = document.getElementById(`pa_${i}`);
        if (!homeInput || !awayInput) {
          alert("Prediction inputs missing.");
          return;
        }

        const homeVal = homeInput.value.trim();
        const awayVal = awayInput.value.trim();

        const res = results[i];
        const hasResult = res && res.home !== "" && res.away !== "";

        if (hasResult) {
          // Predictions locked for this fixture
          newPreds.push(savedPreds[i] || { home: "", away: "" });
          continue;
        }

        if (homeVal === "" && awayVal === "") {
          // Allow skipping this fixture
          newPreds.push(savedPreds[i] || { home: "", away: "" });
          continue;
        } else if (homeVal === "" || awayVal === "") {
          alert(`Please enter both home and away scores or leave both blank for fixture #${i+1}.`);
          return;
        } else {
          const homeNum = parseInt(homeVal, 10);
          const awayNum = parseInt(awayVal, 10);
          if (isNaN(homeNum) || isNaN(awayNum)) {
            alert("Please enter valid numbers for all predictions.");
            return;
          }
          newPreds.push({ home: homeNum, away: awayNum });
        }
      }

      localStorage.setItem(`gw_${currentWeek}_predictions_${currentPlayer}`, JSON.stringify(newPreds));
      alert("Predictions saved!");
      renderPredictions();
      renderAllPredictions();
      renderPointsPerFixture();
      updateLeaderboard();
    });

    submitResultsBtn.addEventListener("click", () => {
      if (currentPlayer !== "david") {
        alert("Only David can submit results.");
        return;
      }
      if (!currentWeek) {
        alert("Please select a game week.");
        return;
      }
      const fixtures = getFixtures(currentWeek);
      if (fixtures.length === 0) {
        alert("Please add fixtures first.");
        return;
      }
      const savedResults = getResults(currentWeek);
      const newResults = [];
      let changed = false;

      for(let i=0; i < fixtures.length; i++) {
        const homeInput = document.getElementById(`rh_${i}`);
        const awayInput = document.getElementById(`ra_${i}`);
        if (!homeInput || !awayInput) {
          alert("Result inputs missing.");
          return;
        }
        const homeVal = homeInput.value.trim();
        const awayVal = awayInput.value.trim();

        if (homeVal === "" && awayVal === "") {
          // keep old if exists
          newResults.push(savedResults[i] || { home: "", away: "" });
        } else if (homeVal === "" || awayVal === "") {
          alert(`Please enter both home and away scores or leave both blank for fixture #${i+1}.`);
          return;
        } else {
          const homeNum = parseInt(homeVal, 10);
          const awayNum = parseInt(awayVal, 10);
          if (isNaN(homeNum) || isNaN(awayNum)) {
            alert("Please enter valid numbers for all results.");
            return;
          }
          newResults.push({ home: homeNum, away: awayNum });
          if (!savedResults[i] || savedResults[i].home !== homeNum || savedResults[i].away !== awayNum) {
            changed = true;
          }
        }
      }

      if (!changed) {
        alert("No changes detected to results.");
        return;
      }

      saveResults(currentWeek, newResults);
      alert("Results saved!");
      renderResults();
      renderPredictions();
      renderPointsPerFixture();
      updateLeaderboard();
    });
  </script>
</body>
</html>
