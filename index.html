const players = ["david", "katja", "mark", "jus"];
const totalGameWeeks = 38;
let currentPlayer = null;

const playerSelect = document.getElementById("playerSelect");
const gwSelect = document.getElementById("gameWeek");
const fixturesContainer = document.getElementById("fixtures");
const predictionsContainer = document.getElementById("predictions");
const resultsContainer = document.getElementById("results");
const submitPredictionsBtn = document.getElementById("submitPredictions");
const submitResultsBtn = document.getElementById("submitResults");

playerSelect.addEventListener("change", e => {
  currentPlayer = e.target.value;
  loadAll();
});

for (let i = 1; i <= totalGameWeeks; i++) {
  const opt = document.createElement("option");
  opt.value = i;
  opt.textContent = `Week ${i}`;
  gwSelect.appendChild(opt);
}
gwSelect.addEventListener("change", loadAll);

document.getElementById("addFixture").addEventListener("click", () => {
  const div = document.createElement("div");
  div.className = "flex gap-2 mb-2";
  div.innerHTML = `
    <input placeholder="Home" class="p-1 border rounded w-32" />
    <span>vs</span>
    <input placeholder="Away" class="p-1 border rounded w-32" />
  `;
  fixturesContainer.appendChild(div);
  saveAndReload();
});

fixturesContainer.addEventListener("input", () => {
  if (!gwSelect.value) return;
  saveAndReload();
});

submitPredictionsBtn.addEventListener("click", () => {
  const gw = gwSelect.value;
  if (!currentPlayer) {
    alert("Please select a player first.");
    return;
  }
  const fixtureData = getFixtureData(gw);
  if (fixtureData.length === 0) {
    alert("Please add fixtures first.");
    return;
  }
  const predictions = [];
  for (let i = 0; i < fixtureData.length; i++) {
    const homeInput = document.getElementById(`pred_home_${i}`);
    const awayInput = document.getElementById(`pred_away_${i}`);
    if (!homeInput || !awayInput) {
      alert("Prediction inputs missing.");
      return;
    }
    const home = parseInt(homeInput.value);
    const away = parseInt(awayInput.value);
    if (isNaN(home) || isNaN(away)) {
      alert("Please enter valid numbers for all predictions.");
      return;
    }
    predictions.push({ home, away });
  }
  localStorage.setItem(`gw_${gw}_predictions_${currentPlayer}`, JSON.stringify(predictions));
  loadPredictions(gw);
  updateLeaderboard();
  alert("Predictions saved!");
});

submitResultsBtn.addEventListener("click", () => {
  const gw = gwSelect.value;
  const fixtureData = getFixtureData(gw);
  if (fixtureData.length === 0) {
    alert("Please add fixtures first.");
    return;
  }
  const results = [];
  for (let i = 0; i < fixtureData.length; i++) {
    const homeInput = document.getElementById(`res_home_${i}`);
    const awayInput = document.getElementById(`res_away_${i}`);
    if (!homeInput || !awayInput) {
      alert("Result inputs missing.");
      return;
    }
    const home = parseInt(homeInput.value);
    const away = parseInt(awayInput.value);
    if (isNaN(home) || isNaN(away)) {
      alert("Please enter valid numbers for all results.");
      return;
    }
    results.push({ home, away });
  }
  localStorage.setItem(`gw_${gw}_results`, JSON.stringify(results));
  updateLeaderboard();
  alert("Results saved!");
});

function getFixtureData(gw) {
  return JSON.parse(localStorage.getItem(`gw_${gw}_fixtures`) || "[]");
}

function saveFixtures(gw) {
  const fixtureEls = fixturesContainer.querySelectorAll("div");
  const fixtures = Array.from(fixtureEls).map(el => {
    const inputs = el.querySelectorAll("input");
    return { home: inputs[0].value.trim(), away: inputs[1].value.trim() };
  }).filter(f => f.home && f.away);
  localStorage.setItem(`gw_${gw}_fixtures`, JSON.stringify(fixtures));
}

function loadFixtures(gw) {
  const fixtures = getFixtureData(gw);
  fixturesContainer.innerHTML = "";
  fixtures.forEach(f => {
    const div = document.createElement("div");
    div.className = "flex gap-2 mb-2";
    div.innerHTML = `
      <input value="${f.home}" class="p-1 border rounded w-32" />
      <span>vs</span>
      <input value="${f.away}" class="p-1 border rounded w-32" />
    `;
    fixturesContainer.appendChild(div);
  });
}

function loadPredictions(gw) {
  const fixtureData = getFixtureData(gw);
  predictionsContainer.innerHTML = "";

  console.log("Current Player:", currentPlayer);
  console.log("Fixture Data:", fixtureData);

  if (fixtureData.length === 0) {
    predictionsContainer.textContent = "No fixtures loaded. Please add fixtures.";
    return;
  }
  if (!currentPlayer) {
    predictionsContainer.textContent = "Please select a player to enter predictions.";
    return;
  }

  const existing = JSON.parse(localStorage.getItem(`gw_${gw}_predictions_${currentPlayer}`) || "null");

  if (!existing) {
    // Show inputs for predictions
    fixtureData.forEach((f, i) => {
      const row = document.createElement("div");
      row.className = "flex gap-2 items-center mb-2";
      row.innerHTML = `
        <label class="w-32">${f.home}</label>
        <input id="pred_home_${i}" type="number" class="w-12 text-center border p-1 rounded" />
        <span>:</span>
        <input id="pred_away_${i}" type="number" class="w-12 text-center border p-1 rounded" />
        <label class="w-32">${f.away}</label>
      `;
      predictionsContainer.appendChild(row);
    });
  } else {
    // Show submitted predictions as text and other players' predictions
    fixtureData.forEach((f, i) => {
      const row = document.createElement("div");
      row.className = "flex gap-2 items-center mb-2";
      row.innerHTML = `
        <span class="w-32">${f.home}</span>
        <span class="font-bold">${existing[i]?.home ?? "-"}</span>
        <span>:</span>
        <span class="font-bold">${existing[i]?.away ?? "-"}</span>
        <span class="w-32">${f.away}</span>
      `;
      predictionsContainer.appendChild(row);
    });

    players.forEach(player => {
      if (player === currentPlay
