document.addEventListener("DOMContentLoaded", () => {
  // Put all the JS code here, e.g.:

  const players = ["david", "katja", "mark", "jus"];
  const totalGameWeeks = 38;
  let currentPlayer = null;

  const playerSelect = document.getElementById("playerSelect");
  const gwSelect = document.getElementById("gameWeek");
  const fixturesContainer = document.getElementById("fixtures");
  const predictionsContainer = document.getElementById("predictions");
  const resultsContainer = document.getElementById("results");
  const submitPredictionsBtn = document.getElementById("submitPredictions");
  const submitResultsBtn = document.getElementById("submitResults");

  // Populate gameweek selector
  for (let i = 1; i <= totalGameWeeks; i++) {
    const opt = document.createElement("option");
    opt.value = i;
    opt.textContent = `Week ${i}`;
    gwSelect.appendChild(opt);
  }

  playerSelect.addEventListener("change", e => {
    currentPlayer = e.target.value;
    loadAll();
  });

  gwSelect.addEventListener("change", loadAll);

  document.getElementById("addFixture").addEventListener("click", () => {
    const div = document.createElement("div");
    div.className = "flex gap-2 mb-2";
    div.innerHTML = `
      <input placeholder="Home" class="p-1 border rounded w-32" />
      <span>vs</span>
      <input placeholder="Away" class="p-1 border rounded w-32" />
    `;
    fixturesContainer.appendChild(div);
    saveAndReload();
  });

  fixturesContainer.addEventListener("input", () => {
    if (!gwSelect.value) return;
    saveAndReload();
  });

  submitPredictionsBtn.addEventListener("click", () => {
    const gw = gwSelect.value;
    if (!currentPlayer) {
      alert("Please select a player first.");
      return;
    }
    const fixtureData = getFixtureData(gw);
    if (fixtureData.length === 0) {
      alert("Please add fixtures first.");
      return;
    }
    const predictions = [];
    for (let i = 0; i < fixtureData.length; i++) {
      const homeInput = document.getElementById(`pred_home_${i}`);
      const awayInput = document.getElementById(`pred_away_${i}`);
      if (!homeInput || !awayInput) {
        alert("Prediction inputs missing.");
        return;
      }
      const home = parseInt(homeInput.value);
      const away = parseInt(awayInput.value);
      if (isNaN(home) || isNaN(away)) {
        alert("Please enter valid numbers for all predictions.");
        return;
      }
      predictions.push({ home, away });
    }
    localStorage.setItem(`gw_${gw}_predictions_${currentPlayer}`, JSON.stringify(predictions));
    loadPredictions(gw);
    updateLeaderboard();
    alert("Predictions saved!");
  });

  submitResultsBtn.addEventListener("click", () => {
    const gw = gwSelect.value;
    const fixtureData = getFixtureData(gw);
    if (fixtureData.length === 0) {
      alert("Please add fixtures first.");
      return;
    }
    const results = [];
    for (let i = 0; i < fixtureData.length; i++) {
      const homeInput = document.getElementById(`res_home_${i}`);
      const awayInput = document.getElementById(`res_away_${i}`);
      if (!homeInput || !awayInput) {
        alert("Result inputs missing.");
        return;
      }
      const home = parseInt(homeInput.value);
      const away = parseInt(awayInput.value);
      if (isNaN(home) || isNaN(away)) {
        alert("Please enter valid numbers for all results.");
        return;
      }
      results.push({ home, away });
    }
    localStorage.setItem(`gw_${gw}_results`, JSON.stringify(results));
    updateLeaderboard();
    alert("Results saved!");
  });

  function getFixtureData(gw) {
    return JSON.parse(localStorage.getItem(`gw_${gw}_fixtures`) || "[]");
  }

  function saveFixtures(gw) {
    const fixtureEls = fixturesContainer.querySelectorAll("div");
    const fixtures = Array.from(fixtureEls).map(el => {
      const inputs = el.querySelectorAll("input");
      return { home: inputs[0].value.trim(), away: inputs[1].value.trim() };
    }).filter(f => f.home && f.away);
    localStorage.setItem(`gw_${gw}_fixtures`, JSON.stringify(fixtures));
  }

  function loadFixtures(gw) {
    const fixtures = getFixtureData(gw);
    fixturesContainer.innerHTML = "";
    fixtures.forEach(f => {
      const div = document.createElement("div");
      div.className = "flex gap-2 mb-2";
      div.innerHTML = `
        <input value="${f.home}" class="p-1 border rounded w-32" />
        <span>vs</span>
        <input value="${f.away}" class="p-1 border rounded w-32" />
      `;
      fixturesContainer.appendChild(div);
    });
  }

  function loadPredictions(gw) {
    const fixtureData = getFixtureData(gw);
    predictionsContainer.innerHTML = "";

    if (fixtureData.length === 0) {
      predictionsContainer.textContent = "No fixtures loaded. Please add fixtures.";
      return;
    }
    if (!currentPlayer) {
      predictionsContainer.textContent = "Please select a player to enter predictions.";
      return;
    }

    const existing = JSON.parse(localStorage.getItem(`gw_${gw}_predictions_${currentPlayer}`) || "null");

    if (!existing) {
      fixtureData.forEach((f, i) => {
        const row = document.createElement("div");
        row.className = "flex gap-2 items-center mb-2";
        row.innerHTML = `
          <label class="w-32">${f.home}</label>
          <input id="pred_home_${i}" type="number" class="w-12 text-center border p-1 rounded" />
          <span>:</span>
          <input id="pred_away_${i}" type="number" class="w-12 text-center border p-1 rounded" />
          <label class="w-32">${f.away}</label>
        `;
        predictionsContainer.appendChild(row);
      });
    } else {
      fixtureData.forEach((f, i) => {
        const row = document.createElement("div");
        row.className = "flex gap-2 items-center mb-2";
        row.innerHTML = `
          <span class="w-32">${f.home}</span>
          <span class="font-bold">${existing[i]?.home ?? "-"}</span>
          <span>:</span>
          <span class="font-bold">${existing[i]?.away ?? "-"}</span>
          <span class="w-32">${f.away}</span>
        `;
        predictionsContainer.appendChild(row);
      });

      players.forEach(player => {
        if (player === currentPlayer) return;
        const preds = JSON.parse(localStorage.getItem(`gw_${gw}_predictions_${player}`) || "null");
        if (!preds) return;
        const label = document.createElement("h3");
        label.textContent = `${player.charAt(0).toUpperCase() + player.slice(1)}'s Predictions:`;
        label.className = "font-bold mt-4";
        predictionsContainer.appendChild(label);

        preds.forEach((p, i) => {
          const pEl = document.createElement("div");
          pEl.textContent = `${fixtureData[i].home} ${p.home} : ${p.away} ${fixtureData[i].away}`;
          predictionsContainer.appendChild(pEl);
        });
      });
    }
  }

  function loadResults(gw) {
    const fixtureData = getFixtureData(gw);
    const results = JSON.parse(localStorage.getItem(`gw_${gw}_results`) || "[]");
    resultsContainer.innerHTML = "";
    fixtureData.forEach((f, i) => {
      const row = document.createElement("div");
      row.className = "flex gap-2 items-center mb-2";
      row.innerHTML = `
        <label class="w-32">${f.home}</label>
        <input id="res_home_${i}" type="number" class="w-12 border p-1 rounded" value="${results[i]?.home ?? ""}" />
        <span>:</span>
        <input id="res_away_${i}" type="number" class="w-12 border p-1 rounded" value="${results[i]?.away ?? ""}" />
        <label class="w-32">${f.away}</label>
      `;
      resultsContainer.appendChild(row);
    });
  }

  function updateLeaderboard() {
    const scores = {};
    players.forEach(p => (scores[p] = 0));
    for (let gw = 1; gw <= totalGameWeeks; gw++) {
      const fixtures = JSON.parse(localStorage.getItem(`gw_${gw}_fixtures`) || "[]");
      const results = JSON.parse(localStorage.getItem(`gw_${gw}_results`) || "[]");
      if (!results.length) continue;
      players.forEach(player => {
        const preds = JSON.parse(localStorage.getItem(`gw_${gw}_predictions_${player}`) || "null");
        if (!preds) return;
        preds.forEach((p, i) => {
          const actual = results[i];
          if (!actual) return;
          let score = 0;
          if (p.home === actual.home) score++;
          if (p.away === actual.away) score++;
          const predDiff = p.home - p.away;
          const actualDiff = actual.home - actual.away;
          if ((predDiff === 0 && actualDiff === 0) || (predDiff * actualDiff > 0)) score += 2;
          if (p.home === actual.home && p.away === actual.away) score++;
          scores[player] += score;
        });
      });
    }
    const board = document.getElementById("leaderboard");
    board.innerHTML = Object.entries(scores)
      .sort((a, b) => b[1] - a[1])
      .map(
        ([p, s]) =>
          `<div><strong>${p.charAt(0).toUpperCase() + p.slice(1)}:</strong> ${s} pts</div>`
      )
      .join("");
  }

  function loadAll() {
    const gw = gwSelect.value;
    if (!currentPlayer || !gw) {
      predictionsContainer.textContent = "Please select player and game week.";
      return;
    }
    loadFixtures(gw);
    loadPredictions(gw);
    loadResults(gw);
    updateLeaderboard();
  }

  function saveAndReload() {
    saveFixtures(gwSelect.value);
    loadPredictions(gwSelect.value);
    loadResults(gwSelect.value);
    updateLeaderboard();
  }
});
