<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Premier League Prediction Game</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 p-6 text-gray-800">
  <div class="max-w-3xl mx-auto bg-white p-6 rounded shadow">
    <h1 class="text-2xl font-bold mb-4">Premier League Prediction Game</h1>

    <div class="grid grid-cols-2 gap-4 mb-6">
      <div>
        <label class="block font-semibold mb-1" for="player">Player</label>
        <select id="player" class="w-full border p-2 rounded">
          <option value="">-- Select Player --</option>
          <option value="david">David</option>
          <option value="katja">Katja</option>
          <option value="mark">Mark</option>
          <option value="jus">Jus</option>
        </select>
      </div>
      <div>
        <label class="block font-semibold mb-1" for="week">Game Week</label>
        <select id="week" class="w-full border p-2 rounded">
          <option value="">-- Select Week --</option>
          <!-- options will be added dynamically -->
        </select>
      </div>
    </div>

    <div class="mb-6">
      <h2 class="text-xl font-semibold mb-2">Add Fixture</h2>
      <div id="fixtureControls" class="flex gap-2 mb-2">
        <input id="homeTeam" placeholder="Home Team" class="flex-1 border p-2 rounded" />
        <input id="awayTeam" placeholder="Away Team" class="flex-1 border p-2 rounded" />
        <button id="addFixture" class="bg-blue-500 text-white px-4 py-2 rounded">Add</button>
      </div>
      <div id="fixturesDiv" class="text-sm text-gray-600"></div>
    </div>

    <div class="mb-6">
      <h2 class="text-xl font-semibold mb-2">Your Predictions</h2>
      <div id="predictionsDiv"></div>
      <button id="submitPredictions" class="mt-2 bg-green-600 text-white px-4 py-2 rounded">Submit Predictions</button>
    </div>

    <div class="mb-6">
      <h2 class="text-xl font-semibold mb-2">Actual Results</h2>
      <div id="resultsDiv"></div>
      <button id="submitResults" class="mt-2 bg-purple-600 text-white px-4 py-2 rounded">Submit Results</button>
    </div>

    <div class="mb-6">
      <h2 class="text-xl font-semibold mb-2">Points per Fixture (after results submitted)</h2>
      <div id="pointsPerFixtureDiv" class="text-sm text-gray-700"></div>
    </div>

    <div class="mb-6">
      <h2 class="text-xl font-semibold mb-2">All Predictions</h2>
      <div id="allPredictionsDiv"></div>
    </div>

    <div class="mb-6">
      <h2 class="text-xl font-semibold mb-2">Leaderboard</h2>
      <div id="leaderboardDiv"></div>
      <div id="overallLeaderboardDiv" class="mt-4 border-t pt-4 text-gray-700"></div>
    </div>
  </div>

  <script>
    const players = ["david", "katja", "mark", "jus"];
    const playerEl = document.getElementById("player");
    const weekEl = document.getElementById("week");
    const fixturesDiv = document.getElementById("fixturesDiv");
    const predictionsDiv = document.getElementById("predictionsDiv");
    const resultsDiv = document.getElementById("resultsDiv");
    const allPredictionsDiv = document.getElementById("allPredictionsDiv");
    const leaderboardDiv = document.getElementById("leaderboardDiv");
    const overallLeaderboardDiv = document.getElementById("overallLeaderboardDiv");
    const pointsPerFixtureDiv = document.getElementById("pointsPerFixtureDiv");
    const fixtureControls = document.getElementById("fixtureControls");

    let currentPlayer = "";
    let currentWeek = "";

    // Populate week dropdown dynamically on DOMContentLoaded
    document.addEventListener("DOMContentLoaded", () => {
      for (let i = 1; i <= 38; i++) {
        const opt = document.createElement("option");
        opt.value = i;
        opt.textContent = `Week ${i}`;
        weekEl.appendChild(opt);
      }
      updateFixtureControlsVisibility();
    });

    function safeJSON(key) {
      try { return JSON.parse(localStorage.getItem(key)); } catch { return null; }
    }

    function getFixtures(week) {
      return safeJSON(`gw_${week}_fixtures`) || [];
    }

    function saveFixtures(week, fixtures) {
      localStorage.setItem(`gw_${week}_fixtures`, JSON.stringify(fixtures));
    }

    function renderFixtures() {
      const fixtures = getFixtures(currentWeek);
      if (fixtures.length === 0) {
        fixturesDiv.textContent = "No fixtures added for this week.";
        return;
      }
      fixturesDiv.innerHTML = "";
      fixtures.forEach((f, i) => {
        const div = document.createElement("div");
        div.className = "flex justify-between items-center border-b py-1";
        div.innerHTML = `<span>${f.home} vs ${f.away}</span>`;
        // Only David sees delete button
        if (currentPlayer === "david") {
          const delBtn = document.createElement("button");
          delBtn.textContent = "Delete";
          delBtn.className = "ml-4 bg-red-500 text-white px-2 py-1 rounded text-xs";
          delBtn.addEventListener("click", () => {
            if(confirm(`Delete fixture: ${f.home} vs ${f.away}?`)) {
              fixtures.splice(i, 1);
              saveFixtures(currentWeek, fixtures);
              renderFixtures();
              renderPredictions();
              renderResults();
              renderAllPredictions();
              renderPointsPerFixture();
              updateLeaderboard();
            }
          });
          div.appendChild(delBtn);
        }
        fixturesDiv.appendChild(div);
      });
    }

    function renderPredictions() {
      predictionsDiv.innerHTML = "";
      const fixtures = getFixtures(currentWeek);
      if (!currentPlayer || !currentWeek) {
        predictionsDiv.textContent = "Select player and week to enter predictions.";
        return;
      }
      if (fixtures.length === 0) {
        predictionsDiv.textContent = "Add fixtures first.";
        return;
      }
      const saved = safeJSON(`gw_${currentWeek}_predictions_${currentPlayer}`) || [];
      fixtures.forEach((f, i) => {
        const pred = saved[i] || { home: "", away: "" };
        predictionsDiv.innerHTML += `
          <div class="flex gap-2 items-center mb-2">
            <label class="w-32">${f.home}</label>
            <input id="ph_${i}" type="number" class="w-12 border p-1 rounded" value="${pred.home}" min="0" />
            <span>:</span>
            <input id="pa_${i}" type="number" class="w-12 border p-1 rounded" value="${pred.away}" min="0" />
            <label class="w-32">${f.away}</label>
          </div>`;
      });
    }

    function renderResults() {
      resultsDiv.innerHTML = "";
      const fixtures = getFixtures(currentWeek);
      if (fixtures.length === 0) {
        resultsDiv.textContent = "Add fixtures first.";
        return;
      }
      const saved = safeJSON(`gw_${currentWeek}_results`) || [];
      fixtures.forEach((f, i) => {
        const res = saved[i] || { home: "", away: "" };
        resultsDiv.innerHTML += `
          <div class="flex gap-2 items-center mb-2">
            <label class="w-32">${f.home}</label>
            <input id="rh_${i}" type="number" class="w-12 border p-1 rounded" value="${res.home}" min="0" />
            <span>:</span>
            <input id="ra_${i}" type="number" class="w-12 border p-1 rounded" value="${res.away}" min="0" />
            <label class="w-32">${f.away}</label>
          </div>`;
      });
    }

    function renderAllPredictions() {
      allPredictionsDiv.innerHTML = "";
      const fixtures = getFixtures(currentWeek);
      if (fixtures.length === 0) {
        allPredictionsDiv.textContent = "No fixtures added.";
        return;
      }
      players.forEach(p => {
        const saved = safeJSON(`gw_${currentWeek}_predictions_${p}`) || [];
        if (!saved.length) return;
        let html = `<h3 class="capitalize font-semibold mt-4">${p}</h3>`;
        saved.forEach((s, i) => {
          html += `<div>${fixtures[i].home} ${s.home}:${s.away} ${fixtures[i].away}</div>`;
        });
        allPredictionsDiv.innerHTML += html;
      });
    }

    // Calculate points for one prediction vs actual result for a fixture
    function calculatePoints(pred, actual) {
      let points = 0;
      if (pred.home === actual.home) points++;
      if (pred.away === actual.away) points++;
      const predDiff = pred.home - pred.away;
      const actualDiff = actual.home - actual.away;
      if ((predDiff === 0 && actualDiff === 0) || (predDiff * actualDiff > 0)) points += 2;
      if (pred.home === actual.home && pred.away === actual.away) points++;
      return points;
    }

    function renderPointsPerFixture() {
      pointsPerFixtureDiv.innerHTML = "";
      const fixtures = getFixtures(currentWeek);
      const results = safeJSON(`gw_${currentWeek}_results`) || [];
      if (fixtures.length === 0 || results.length === 0) {
        pointsPerFixtureDiv.textContent = "Add fixtures and results to see points per fixture.";
        return;
      }
      // Header row with fixture names
      let html = "<table class='w-full border border-collapse text-sm'><thead><tr><th class='border px-2 py-1'>Player</th>";
      fixtures.forEach((f, i) => {
        html += `<th class="border px-2 py-1">${f.home} vs ${f.away}</th>`;
      });
      html += "</tr></thead><tbody>";
      players.forEach(p => {
        const preds = safeJSON(`gw_${currentWeek}_predictions_${p}`) || [];
        html += `<tr><td class="border px-2 py-1 capitalize font-semibold">${p}</td>`;
        fixtures.forEach((_, i) => {
          if (preds[i] && results[i]) {
            const pts = calculatePoints(preds[i], results[i]);
            html += `<td class="border px-2 py-1 text-center">${pts}</td>`;
          } else {
            html += `<td class="border px-2 py-1 text-center">-</td>`;
          }
        });
        html += "</tr>";
      });
      html += "</tbody></table>";
      pointsPerFixtureDiv.innerHTML = html;
    }

    function updateLeaderboard() {
      leaderboardDiv.innerHTML = "";
      const fixtures = getFixtures(currentWeek);
      const results = safeJSON(`gw_${currentWeek}_results`) || [];
      if (fixtures.length === 0 || results.length === 0) {
        leaderboardDiv.textContent = "Add fixtures and results to see leaderboard.";
        return;
      }
      const scores = {};
      players.forEach(p => { scores[p] = 0; });
      players.forEach(p => {
        const saved = safeJSON(`gw_${currentWeek}_predictions_${p}`) || [];
        saved.forEach((s, i) => {
          const r = results[i];
          if (!r) return;
          scores[p] += calculatePoints(s, r);
        });
      });
      // Sort descending
      const sorted = Object.entries(scores).sort((a,b) => b[1] - a[1]);
      let html = "<h3 class='font-semibold mb-2'>Leaderboard for Week " + currentWeek + "</h3>";
      sorted.forEach(([p, s]) => {
        html += `<div class="capitalize font-semibold">${p}: ${s} pts</div>`;
      });
      leaderboardDiv.innerHTML = html;

      // Overall leaderboard over all weeks
      const overallScores = {};
      players.forEach(p => overallScores[p] = 0);
      for(let w=1; w<=38; w++) {
        const weekFixtures = getFixtures(w);
        const weekResults = safeJSON(`gw_${w}_results`) || [];
        if (weekFixtures.length === 0 || weekResults.length === 0) continue;
        players.forEach(p => {
          const weekPreds = safeJSON(`gw_${w}_predictions_${p}`) || [];
          weekPreds.forEach((pred, i) => {
            const actual = weekResults[i];
            if (!actual) return;
            overallScores[p] += calculatePoints(pred, actual);
          });
        });
      }
      const sortedOverall = Object.entries(overallScores).sort((a,b) => b[1] - a[1]);
      let overallHtml = "<h3 class='font-semibold mb-2'>Overall Leaderboard</h3>";
      sortedOverall.forEach(([p, s]) => {
        overallHtml += `<div class="capitalize font-semibold">${p}: ${s} pts</div>`;
      });
      overallLeaderboardDiv.innerHTML = overallHtml;
    }

    function updateFixtureControlsVisibility() {
      // Only David can add/delete fixtures => show/hide fixtureControls and delete buttons dynamically handled in renderFixtures()
      if (currentPlayer === "david") {
        fixtureControls.style.display = "flex";
      } else {
        fixtureControls.style.display = "none";
      }
    }

    function handleChange() {
      currentPlayer = playerEl.value;
      currentWeek = weekEl.value;
      updateFixtureControlsVisibility();
      if (!currentPlayer || !currentWeek) {
        fixturesDiv.textContent = "Select player and week.";
        predictionsDiv.textContent = "";
        resultsDiv.textContent = "";
        allPredictionsDiv.textContent = "";
        pointsPerFixtureDiv.textContent = "";
        leaderboardDiv.textContent = "";
        overallLeaderboardDiv.textContent = "";
        return;
      }
      renderFixtures();
      renderPredictions();
      renderResults();
      renderAllPredictions();
      renderPointsPerFixture();
      updateLeaderboard();
    }

    playerEl.addEventListener("change", handleChange);
    weekEl.addEventListener("change", handleChange);

    document.getElementById("addFixture").addEventListener("click", () => {
      if (!currentWeek) {
        alert("Please select a game week first.");
        return;
      }
      if (currentPlayer !== "david") {
        alert("Only David can add fixtures.");
        return;
      }
      const home = document.getElementById("homeTeam").value.trim();
      const away = document.getElementById("awayTeam").value.trim();
      if (!home || !away) {
        alert("Please enter both Home and Away team names.");
        return;
      }
      const fixtures = getFixtures(currentWeek);
      fixtures.push({ home, away });
      saveFixtures(currentWeek, fixtures);
      document.getElementById("homeTeam").value = "";
      document.getElementById("awayTeam").value = "";
      renderFixtures();
      renderPredictions();
      renderResults();
      renderAllPredictions();
      renderPointsPerFixture();
      updateLeaderboard();
    });

    document.getElementById("submitPredictions").addEventListener("click", () => {
      if (!currentPlayer || !currentWeek) {
        alert("Please select a player and game week first.");
        return;
      }
      const fixtures = getFixtures(currentWeek);
      if (fixtures.length === 0) {
        alert("Please add fixtures first.");
        return;
      }
      const preds = fixtures.map((_, i) => {
        const home = document.getElementById(`ph_${i}`).value;
        const away = document.getElementById(`pa_${i}`).value;
        if (home === "" || away === "") {
          alert("Please enter all predictions.");
          throw new Error("Incomplete predictions");
        }
        return { home: parseInt(home, 10), away: parseInt(away, 10) };
      });
      localStorage.setItem(`gw_${currentWeek}_predictions_${currentPlayer}`, JSON.stringify(preds));
      alert("Predictions saved!");
      renderPredictions();
      renderAllPredictions();
      renderPointsPerFixture();
      updateLeaderboard();
    });

    document.getElementById("submitResults").addEventListener("click", () => {
      if (!currentWeek) {
        alert("Please select a game week first.");
        return;
      }
      if (currentPlayer !== "david") {
        alert("Only David can submit results.");
        return;
      }
      const fixtures = getFixtures(currentWeek);
      if (fixtures.length === 0) {
        alert("Please add fixtures first.");
        return;
      }
      const res = fixtures.map((_, i) => {
        const home = document.getElementById(`rh_${i}`).value;
        const away = document.getElementById(`ra_${i}`).value;
        if (home === "" || away === "") {
          alert("Please enter all results.");
          throw new Error("Incomplete results");
        }
        return { home: parseInt(home, 10), away: parseInt(away, 10) };
      });
      localStorage.setItem(`gw_${currentWeek}_results`, JSON.stringify(res));
      alert("Results saved!");
      renderResults();
      renderPointsPerFixture();
      updateLeaderboard();
    });

    // Initialize placeholders before any selection
    fixturesDiv.textContent = "Select player and week.";
    predictionsDiv.textContent = "";
    resultsDiv.textContent = "";
    allPredictionsDiv.textContent = "";
    pointsPerFixtureDiv.textContent = "";
    leaderboardDiv.textContent = "";
    overallLeaderboard
