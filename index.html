<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Premier League Predictor</title>
  <script type="module" src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
  <script type="module" src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>
  <script type="module" src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js"></script>
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
  <style>
    input[type="number"]::-webkit-inner-spin-button,
    input[type="number"]::-webkit-outer-spin-button {
      opacity: 1;
    }
  </style>
</head>
<body class="bg-gray-100 text-gray-800">
  <div class="max-w-5xl mx-auto p-4">
    <h1 class="text-2xl font-bold mb-4 text-center">Premier League Prediction Game</h1>

    <!-- LOGIN SECTION -->
    <div id="loginSection" class="mb-6">
      <select id="username" class="border p-2 mr-2">
        <option value="" disabled selected>Select user</option>
        <option value="david">David</option>
        <option value="katja">Katja</option>
        <option value="mark">Mark</option>
        <option value="jus">Jus</option>
      </select>
      <input id="password" type="password" class="border p-2 mr-2" placeholder="Password" />
      <button id="loginBtn" class="bg-blue-500 text-white px-4 py-2">Login</button>
    </div>

    <!-- APP UI -->
    <div id="app" style="display:none;">
      <div class="flex justify-between items-center mb-4">
        <span id="welcomeUser" class="font-semibold"></span>
        <button id="logoutBtn" class="bg-gray-400 text-white px-3 py-1 rounded">Logout</button>
      </div>

      <!-- Gameweek Picker -->
      <div class="mb-4">
        <label for="gameweekSelect" class="mr-2 font-medium">Gameweek:</label>
        <select id="gameweekSelect" class="border p-2"></select>
        <span id="gameweekDeadline" class="ml-4 text-sm text-gray-600"></span>
      </div>

      <!-- Fixture Editor (David only) -->
      <div id="fixtureEditor" class="mb-6 hidden">
        <h2 class="text-lg font-semibold mb-2">Edit Fixtures</h2>
        <input id="newHomeTeam" class="border p-2 mr-2" placeholder="Home Team" />
        <input id="newAwayTeam" class="border p-2 mr-2" placeholder="Away Team" />
        <button id="addFixtureBtn" class="bg-green-500 text-white px-3 py-1">Add Fixture</button>
        <div class="mt-2">
          <label class="text-sm">Deadline:</label>
          <input type="datetime-local" id="deadlineInput" class="border p-1 ml-2" />
          <button id="setDeadlineBtn" class="bg-blue-500 text-white px-2 py-1 ml-2 text-sm">Set Deadline</button>
        </div>
      </div>
      <!-- Fixtures Container -->
      <div id="fixturesContainer" class="mb-8"></div>

      <!-- Leaderboards -->
      <div class="mb-6">
        <h2 class="text-lg font-semibold mb-2">Overall Leaderboard</h2>
        <div id="leaderboardOverall" class="overflow-x-auto"></div>

        <h2 class="text-lg font-semibold mt-6 mb-2">Weekly Leaderboard</h2>
        <div id="leaderboardWeekly" class="overflow-x-auto"></div>
      </div>

      <!-- Password Reset Section (David only) -->
      <div id="passwordResetSection" class="hidden mb-8">
        <h2 class="text-lg font-semibold mb-2">Reset Player Password</h2>
        <select id="resetUserSelect" class="border p-2 mr-2"></select>
        <input id="newPasswordInput" class="border p-2 mr-2" placeholder="New Password" />
        <button id="resetPasswordBtn" class="bg-red-500 text-white px-3 py-1">Reset Password</button>
      </div>
    </div> <!-- end #app -->
  </div> <!-- end .container -->
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
  import { getFirestore, doc, setDoc, getDoc, updateDoc, deleteField, onSnapshot, collection, getDocs, deleteDoc } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyA2WG0LUwLCDqmylgezCZ0aH5Q8vTaXTKU",
      authDomain: "pl-predictor-13a6d.firebaseapp.com",
      projectId: "pl-predictor-13a6d",
      storageBucket: "pl-predictor-13a6d.appspot.com",
      messagingSenderId: "286908896536",
      appId: "1:286908896536:web:dabd76b4faaa72a98cfa6d"
    };

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);

  const users = {
    david: "david123",
    katja: "katja123",
    mark: "mark123",
    jus: "jus123"
  };

  let currentUser = "";
  let currentGameweek = "";

  const loginBtn = document.getElementById("loginBtn");
  const logoutBtn = document.getElementById("logoutBtn");
  const appDiv = document.getElementById("app");
  const loginSection = document.getElementById("loginSection");
  const welcomeUser = document.getElementById("welcomeUser");

  loginBtn.onclick = async () => {
    const user = document.getElementById("username").value;
    const pass = document.getElementById("password").value;
    const savedPass = (await getDoc(doc(db, "passwords", user))).data()?.password;
    if (users[user] && (pass === users[user] || pass === savedPass)) {
      currentUser = user;
      loginSection.style.display = "none";
      appDiv.style.display = "block";
      welcomeUser.textContent = `Welcome, ${user}`;
      if (user === "david") {
        document.getElementById("fixtureEditor").classList.remove("hidden");
        document.getElementById("passwordResetSection").classList.remove("hidden");
        populatePasswordResetDropdown();

        const allFixtures = await getDocs(collection(db, "fixtures"));
        if (allFixtures.empty) {
          for (let gw = 1; gw <= 38; gw++) {
            const id = `${gw}_Team A_Team B_${Date.now() + gw}`;
            await setDoc(doc(db, "fixtures", id), { home: "Team A", away: "Team B" });
          }
          alert("Auto-generated 38 gameweeks with placeholder fixtures.");
        }
      }
      loadGameweeks();
    } else {
      alert("Invalid login");
    }
  };

  logoutBtn.onclick = () => location.reload();

  async function loadGameweeks() {
    const snapshot = await getDocs(collection(db, "fixtures"));
    const weeks = [...new Set(snapshot.docs.map(d => d.id.split("_")[0]))]
      .filter(Boolean)
      .sort((a, b) => +a - +b);
    if (weeks.length > 0) {
      currentGameweek = weeks[0];
      document.getElementById("gameweekSelect").innerHTML = weeks.map(w => `<option value="${w}">Gameweek ${w}</option>`).join("");
      document.getElementById("gameweekSelect").value = currentGameweek;
      loadGameweekData();
    } else {
      currentGameweek = "1";
      document.getElementById("gameweekSelect").innerHTML = `<option value="1">Gameweek 1</option>`;
    }
  }

  document.getElementById("gameweekSelect").onchange = (e) => {
    currentGameweek = e.target.value;
    loadGameweekData();
  };

  async function loadGameweekData() {
    const fixturesContainer = document.getElementById("fixturesContainer");
    fixturesContainer.innerHTML = "";

    const fixtureDocs = await getDocs(collection(db, "fixtures"));
    const resultsDoc = await getDoc(doc(db, "results", currentGameweek));
    const predictionsDoc = await getDoc(doc(db, "predictions", currentGameweek));
    const deadlineDoc = await getDoc(doc(db, "deadlines", currentGameweek));

    const fixtures = fixtureDocs.docs.filter(d => d.id.startsWith(currentGameweek + "_")).map(d => ({ id: d.id, ...d.data() }));
    const results = resultsDoc.exists() ? resultsDoc.data() : {};
    const predictions = predictionsDoc.exists() ? predictionsDoc.data() : {};

    fixtures.forEach(fixture => {
      const div = document.createElement("div");
      div.className = "border p-3 my-2 bg-white rounded shadow";

      const result = results[fixture.id];
      const pred = predictions[fixture.id]?.[currentUser];
      const isLocked = !!result;

      const home = fixture.home;
      const away = fixture.away;
      const predHome = pred?.home ?? "";
      const predAway = pred?.away ?? "";
      const resHome = result?.home ?? "";
      const resAway = result?.away ?? "";

      div.innerHTML = `
        <div class="flex justify-between items-center">
          <div class="font-semibold">
            <span class="homeTeam">${home}</span> vs <span class="awayTeam">${away}</span>
          </div>
          ${currentUser === "david" ? `
            <div>
              <button class="text-blue-600 text-sm editBtn">‚úèÔ∏è Edit</button>
              <button class="text-red-500 text-sm deleteFixtureBtn">üóëÔ∏è</button>
            </div>` : ""}
        </div>

        <div class="mt-2 flex space-x-4">
          <div>
            <label class="text-sm block">Your Prediction:</label>
            <input type="number" min="0" class="border p-1 w-12 predHome" value="${predHome}" ${isLocked ? 'disabled' : ''}>
            :
            <input type="number" min="0" class="border p-1 w-12 predAway" value="${predAway}" ${isLocked ? 'disabled' : ''}>
            ${!isLocked ? `<button class="savePred text-blue-600 text-sm ml-2">Save</button>` : ""}
            ${pred ? `<button class="deletePred text-red-500 text-sm ml-2">Delete</button>` : ""}
          </div>

          <div>
            <label class="text-sm block">Result:</label>
            ${
              currentUser === "david" || result ? `
                <input type="number" min="0" class="border p-1 w-12 resHome" value="${resHome}" ${currentUser !== "david" ? 'disabled' : ''}>
                :
                <input type="number" min="0" class="border p-1 w-12 resAway" value="${resAway}" ${currentUser !== "david" ? 'disabled' : ''}>
                ${currentUser === "david" ? `<button class="saveRes text-green-600 text-sm ml-2">Save</button>` : ""}
              ` : `<span class="text-sm text-gray-500">Not submitted</span>`
            }
          </div>
        </div>

        <div class="text-sm mt-2 playersPredictions"></div>
      `;

      // Append div
      fixturesContainer.appendChild(div);

      // Save prediction
      div.querySelector(".savePred")?.addEventListener("click", async () => {
        const h = div.querySelector(".predHome").value;
        const a = div.querySelector(".predAway").value;
        const snap = await getDoc(doc(db, "predictions", currentGameweek));
        const data = snap.exists() ? snap.data() : {};
        if (!data[fixture.id]) data[fixture.id] = {};
        data[fixture.id][currentUser] = { home: +h, away: +a };
        await setDoc(doc(db, "predictions", currentGameweek), data);
        loadGameweekData();
      });

      // Delete prediction
      div.querySelector(".deletePred")?.addEventListener("click", async () => {
        const snap = await getDoc(doc(db, "predictions", currentGameweek));
        if (!snap.exists()) return;
        const data = snap.data();
        if (data[fixture.id]) {
          delete data[fixture.id][currentUser];
          if (Object.keys(data[fixture.id]).length === 0) delete data[fixture.id];
        }
        await setDoc(doc(db, "predictions", currentGameweek), data);
        loadGameweekData();
      });

      // Save result
      div.querySelector(".saveRes")?.addEventListener("click", async () => {
        const h = div.querySelector(".resHome").value;
        const a = div.querySelector(".resAway").value;
        const snap = await getDoc(doc(db, "results", currentGameweek));
        const data = snap.exists() ? snap.data() : {};
        data[fixture.id] = { home: +h, away: +a };
        await setDoc(doc(db, "results", currentGameweek), data);
        loadGameweekData();
      });

      // Edit team names
      div.querySelector(".editBtn")?.addEventListener("click", async () => {
        const newHome = prompt("New home team name:", home);
        const newAway = prompt("New away team name:", away);
        if (newHome && newAway) {
          await setDoc(doc(db, "fixtures", fixture.id), { home: newHome, away: newAway });
          loadGameweekData();
        }
      });

      // Delete fixture
      div.querySelector(".deleteFixtureBtn")?.addEventListener("click", async () => {
        await deleteDoc(doc(db, "fixtures", fixture.id));
        loadGameweekData();
      });

      // Show all predictions
      const allPreds = predictions[fixture.id] || {};
      let predText = "";
      for (let user in allPreds) {
        const p = allPreds[user];
        const res = results[fixture.id];
        const pts = res ? calculatePoints(p, res) : "-";
        predText += `${user}: ${p.home}:${p.away} (${pts} pts)<br>`;
      }
      div.querySelector(".playersPredictions").innerHTML = predText;
    });

    renderLeaderboards(predictions, results, fixtures);
  }

  function calculatePoints(pred, res) {
    let pts = 0;
    if (pred.home === res.home) pts++;
    if (pred.away === res.away) pts++;
    if (Math.sign(pred.home - pred.away) === Math.sign(res.home - res.away)) pts += 2;
    if (pred.home === res.home && pred.away === res.away) pts++;
    return pts;
  }

  function renderLeaderboards(predictions, results, fixtures) {
    const overall = {};
    const weekly = {};

    for (let f of fixtures) {
      const fid = f.id;
      const res = results[fid];
      if (!res) continue;
      const preds = predictions[fid] || {};
      for (let user in preds) {
        const pts = calculatePoints(preds[user], res);
        overall[user] = (overall[user] || 0) + pts;
        weekly[user] = (weekly[user] || 0) + pts;
      }
    }

    const render = obj =>
      `<table class="table-auto border w-full text-sm">
        <thead><tr><th class="border px-2">Player</th><th class="border px-2">Points</th></tr></thead>
        <tbody>
          ${Object.entries(obj).sort((a,b)=>b[1]-a[1]).map(([u,p]) =>
            `<tr><td class="border px-2">${u}</td><td class="border px-2">${p}</td></tr>`).join("")}
        </tbody></table>`;

    document.getElementById("leaderboardOverall").innerHTML = render(overall);
    document.getElementById("leaderboardWeekly").innerHTML = render(weekly);
  }

  function populatePasswordResetDropdown() {
    document.getElementById("resetUserSelect").innerHTML =
      Object.keys(users).map(u => `<option value="${u}">${u}</option>`).join("");
  }

  document.getElementById("resetPasswordBtn").onclick = async () => {
    const user = document.getElementById("resetUserSelect").value;
    const pass = document.getElementById("newPasswordInput").value.trim();
    if (!pass) return alert("Enter new password");
    await setDoc(doc(db, "passwords", user), { password: pass });
    alert("Password updated");
    document.getElementById("newPasswordInput").value = "";
  };

  document.getElementById("addFixtureBtn").onclick = async () => {
    const home = document.getElementById("newHomeTeam").value.trim();
    const away = document.getElementById("newAwayTeam").value.trim();
    if (!home || !away) return alert("Enter both teams");
    const id = `${currentGameweek}_${home}_${away}_${Date.now()}`;
    await setDoc(doc(db, "fixtures", id), { home, away });
    document.getElementById("newHomeTeam").value = "";
    document.getElementById("newAwayTeam").value = "";
    loadGameweekData();
  };

  document.getElementById("setDeadlineBtn").onclick = async () => {
    const deadline = document.getElementById("deadlineInput").value;
    if (!deadline) return;
    await setDoc(doc(db, "deadlines", currentGameweek), { deadline });
    loadGameweekData();
  };
</script>
</body>
</html>
