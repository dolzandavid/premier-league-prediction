<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Premier League Prediction Game - Login</title>
<script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 p-4 text-gray-900">

<div id="loginPage" class="max-w-md mx-auto mt-20 bg-white p-6 rounded shadow">
  <h1 class="text-2xl font-bold mb-6 text-center">Login to Prediction Game</h1>
  <form id="loginForm" class="flex flex-col gap-4">
    <label for="loginPlayer" class="font-semibold">Select Player:</label>
    <select id="loginPlayer" required class="p-2 border rounded">
      <option value="" disabled selected>Choose player</option>
      <option value="david">David</option>
      <option value="katja">Katja</option>
      <option value="mark">Mark</option>
      <option value="jus">Jus</option>
    </select>

    <label for="loginPassword" class="font-semibold">Enter Password:</label>
    <input type="password" id="loginPassword" required placeholder="Enter password" class="p-2 border rounded" />

    <button type="submit" class="bg-blue-600 text-white py-2 rounded hover:bg-blue-700">Login</button>
  </form>
  <p id="loginMsg" class="text-red-600 mt-3 text-center"></p>
</div>

<div id="gamePage" class="max-w-4xl mx-auto hidden">
  <div class="flex justify-between items-center mb-4">
    <h1 class="text-2xl font-bold">Premier League Prediction Game</h1>
    <button id="logoutBtn" class="bg-red-600 text-white px-3 py-1 rounded hover:bg-red-700">Logout</button>
  </div>

  <!-- Gameweek Navigation -->
  <div class="mb-4">
    <label for="gameWeek" class="font-semibold">Game Week:</label>
    <select id="gameWeek" class="ml-2 p-1 border rounded">
      <!-- JS will populate this -->
    </select>
  </div>

  <!-- Deadline -->
  <div class="mb-4">
    <label class="font-semibold">Deadline:</label>
    <span id="deadlineDisplay" class="ml-2"></span>
    <input type="date" id="deadlineInput" class="ml-2 p-1 border rounded hidden" />
    <button id="saveDeadlineBtn" class="ml-2 bg-blue-600 text-white px-3 py-1 rounded hidden">Save Deadline</button>
  </div>

  <!-- Fixtures Input (David only) -->
  <div class="mb-6" id="fixturesSection">
    <h2 class="text-xl font-semibold mb-2">Fixtures</h2>
    <button id="addFixture" class="mb-2 bg-blue-500 text-white px-2 py-1 rounded hidden">Add Fixture</button>
    <div id="fixtures"></div>
  </div>

  <!-- Predictions Section -->
  <div class="mb-6">
    <h2 class="text-xl font-semibold mb-2">Your Predictions</h2>
    <div id="predictions"></div>
  </div>

  <button id="submitPredictions" class="mb-6 bg-green-500 text-white px-4 py-2 rounded">Submit Predictions</button>

  <!-- Results Input -->
  <div class="mb-6">
    <h2 class="text-xl font-semibold mb-2">Actual Results</h2>
    <div id="results"></div>
    <button id="submitResults" class="mt-2 bg-purple-500 text-white px-4 py-2 rounded hidden">Submit Results</button>
  </div>

  <!-- Points per Fixture -->
  <div class="mb-6">
    <h2 class="text-xl font-semibold mb-2">Points per Fixture</h2>
    <div id="pointsPerFixture"></div>
  </div>

  <!-- Leaderboards -->
  <div class="mb-6">
    <h2 class="text-xl font-semibold mb-2">Weekly Leaderboard</h2>
    <div id="weeklyLeaderboard" class="bg-white p-4 rounded shadow mb-4"></div>

    <h2 class="text-xl font-semibold mb-2">Overall Leaderboard</h2>
    <div id="leaderboard" class="bg-white p-4 rounded shadow"></div>
  </div>

  <!-- Export/Import (David only) -->
  <div id="dataBackup" class="mb-6 hidden">
    <h2 class="text-xl font-semibold mb-2">Data Backup (David only)</h2>
    <button id="exportDataBtn" class="bg-yellow-500 text-black px-4 py-2 rounded mr-4">Export Data</button>
    <input type="file" id="importDataInput" accept=".json" class="hidden" />
    <button id="importDataBtn" class="bg-yellow-500 text-black px-4 py-2 rounded">Import Data</button>
  </div>
</div>

<script>
document.addEventListener("DOMContentLoaded", () => {
  const players = ["david", "katja", "mark", "jus"];
  const totalGameWeeks = 38;

  // Login page elements
  const loginPage = document.getElementById("loginPage");
  const loginForm = document.getElementById("loginForm");
  const loginPlayer = document.getElementById("loginPlayer");
  const loginPassword = document.getElementById("loginPassword");
  const loginMsg = document.getElementById("loginMsg");

  // Game page elements
  const gamePage = document.getElementById("gamePage");
  const logoutBtn = document.getElementById("logoutBtn");

  // Elements from previous code inside gamePage
  const gwSelect = document.getElementById("gameWeek");
  const fixturesContainer = document.getElementById("fixtures");
  const fixturesSection = document.getElementById("fixturesSection");
  const predictionsContainer = document.getElementById("predictions");
  const resultsContainer = document.getElementById("results");
  const submitPredictionsBtn = document.getElementById("submitPredictions");
  const submitResultsBtn = document.getElementById("submitResults");
  const addFixtureBtn = document.getElementById("addFixture");
  const deadlineDisplay = document.getElementById("deadlineDisplay");
  const deadlineInput = document.getElementById("deadlineInput");
  const saveDeadlineBtn = document.getElementById("saveDeadlineBtn");
  const pointsPerFixtureContainer = document.getElementById("pointsPerFixture");
  const leaderboardContainer = document.getElementById("leaderboard");
  const weeklyLeaderboardContainer = document.getElementById("weeklyLeaderboard");
  const dataBackupDiv = document.getElementById("dataBackup");
  const exportDataBtn = document.getElementById("exportDataBtn");
  const importDataBtn = document.getElementById("importDataBtn");
  const importDataInput = document.getElementById("importDataInput");

  let currentPlayer = null;
  let currentWeek = null;

  // Initialize gameweek dropdown
  for (let i = 1; i <= totalGameWeeks; i++) {
    const opt = document.createElement("option");
    opt.value = i;
    opt.textContent = `Week ${i}`;
    gwSelect.appendChild(opt);
  }

  // Helper to capitalize player names
  function capitalize(str) {
    return str.charAt(0).toUpperCase() + str.slice(1);
  }

  // LocalStorage helpers
  function getFixtures(gw) {
    return JSON.parse(localStorage.getItem(`gw_${gw}_fixtures`) || "[]");
  }
  function saveFixtures(gw, fixtures) {
    localStorage.setItem(`gw_${gw}_fixtures`, JSON.stringify(fixtures));
  }

  function getPredictions(gw, player) {
    return JSON.parse(localStorage.getItem(`gw_${gw}_predictions_${player}`) || "[]");
  }
  function savePredictions(gw, player, preds) {
    localStorage.setItem(`gw_${gw}_predictions_${player}`, JSON.stringify(preds));
  }

  function getResults(gw) {
    return JSON.parse(localStorage.getItem(`gw_${gw}_results`) || "[]");
  }
  function saveResults(gw, results) {
    localStorage.setItem(`gw_${gw}_results`, JSON.stringify(results));
  }

  function getDeadline(gw) {
    return localStorage.getItem(`gw_${gw}_deadline`) || "";
  }
  function saveDeadline(gw, dateStr) {
    localStorage.setItem(`gw_${gw}_deadline`, dateStr);
  }

  // Password storage (simple, NOT secure, demo only)
  function getPassword(player) {
    return localStorage.getItem(`pw_${player}`) || null;
  }
  function savePassword(player, pw) {
    localStorage.setItem(`pw_${player}`, pw);
  }

  // Show/hide controls based on player
  function updateControlsVisibility() {
    if(currentPlayer === "david") {
      addFixtureBtn.classList.remove("hidden");
      submitResultsBtn.classList.remove("hidden");
      deadlineInput.classList.remove("hidden");
      saveDeadlineBtn.classList.remove("hidden");
      dataBackupDiv.classList.remove("hidden");
      fixturesSection.classList.remove("hidden");
    } else {
      addFixtureBtn.classList.add("hidden");
      submitResultsBtn.classList.add("hidden");
      deadlineInput.classList.add("hidden");
      saveDeadlineBtn.classList.add("hidden");
      dataBackupDiv.classList.add("hidden");
      fixturesSection.classList.add("hidden");
    }
  }

  function renderDeadline() {
    const dl = getDeadline(currentWeek);
    deadlineDisplay.textContent = dl ? new Date(dl).toLocaleDateString() : "No deadline set";
    deadlineInput.value = dl;
  }

  function renderFixtures() {
    if(currentPlayer !== "david") return;
    const fixtures = getFixtures(currentWeek);
    fixturesContainer.innerHTML = "";
    fixtures.forEach((f,i) => {
      const div = document.createElement("div");
      div.className = "flex gap-2 mb-2 items-center";

      div.innerHTML = `
        <input type="text" class="p-1 border rounded w-32" value="${f.home}" data-index="${i}" data-type="home" />
        <span>vs</span>
        <input type="text" class="p-1 border rounded w-32" value="${f.away}" data-index="${i}" data-type="away" />
        <button class="delete-fixture-btn bg-red-700 text-white px-2 py-1 rounded ml-2" data-index="${i}" title="Delete fixture">Delete</button>
      `;
      fixturesContainer.appendChild(div);
    });
  }

  function renderPredictions() {
    const fixtures = getFixtures(currentWeek);
    const results = getResults(currentWeek);
    predictionsContainer.innerHTML = "";

    if(fixtures.length === 0) {
      predictionsContainer.textContent = "No fixtures added.";
      return;
    }
    if(!currentPlayer) {
      predictionsContainer.textContent = "Please select a player.";
      return;
    }

    const playerPreds = getPredictions(currentWeek, currentPlayer);

    fixtures.forEach((f, i) => {
      const resultEntered = results[i] !== undefined;
      const pred = playerPreds[i] || { home: "", away: "" };
      const playerPredExists = (pred.home !== "" && pred.home !== undefined) && (pred.away !== "" && pred.away !== undefined);

      const div = document.createElement("div");
      div.className = "mb-4";

      const predRow = document.createElement("div");
      predRow.className = "flex gap-2 items-center";

      if(resultEntered) {
        predRow.innerHTML = `
          <span class="w-32">${f.home}</span>
          <span class="font-bold">${pred.home !== "" ? pred.home : "-"}</span>
          <span>:</span>
          <span class="font-bold">${pred.away !== "" ? pred.away : "-"}</span>
          <span class="w-32">${f.away}</span>
        `;
      } else {
        predRow.innerHTML = `
          <label class="w-32">${f.home}</label>
          <input type="number" min="0" class="w-12 text-center border p-1 rounded" id="pred_home_${i}" value="${pred.home !== "" ? pred.home : ""}" />
          <span>:</span>
          <input type="number" min="0" class="w-12 text-center border p-1 rounded" id="pred_away_${i}" value="${pred.away !== "" ? pred.away : ""}" />
          <label class="w-32">${f.away}</label>
          <button class="delete-pred-btn bg-red-700 text-white px-2 py-1 rounded ml-2" data-index="${i}" title="Delete prediction for this fixture">Delete Prediction</button>
        `;
      }

      div.appendChild(predRow);

      if(playerPredExists) {
        const otherPlayersPredsDiv = document.createElement("div");
        otherPlayersPredsDiv.className = "ml-36 mt-1 text-sm text-gray-700 italic";

        let othersPredsHTML = "<strong>Other players' predictions:</strong> ";
        let othersFound = false;

        players.forEach(p => {
          if(p === currentPlayer) return;
          const pPreds = getPredictions(currentWeek, p);
          if(pPreds.length > i) {
            const op = pPreds[i];
            if(op && op.home !== undefined && op.away !== undefined && op.home !== "" && op.away !== "") {
              othersFound = true;
              othersPredsHTML += `${capitalize(p)}: ${op.home} - ${op.away} &nbsp;&nbsp; `;
            }
          }
        });

        if(othersFound) {
          otherPlayersPredsDiv.innerHTML = othersPredsHTML;
          div.appendChild(otherPlayersPredsDiv);
        }
      }

      predictionsContainer.appendChild(div);
    });
  }

  function renderResults() {
    const fixtures = getFixtures(currentWeek);
    const results = getResults(currentWeek);
    resultsContainer.innerHTML = "";

    if(fixtures.length === 0) {
      resultsContainer.textContent = "No fixtures added.";
      return;
    }

    fixtures.forEach((f,i) => {
      const rhVal = results[i]?.home ?? "";
      const raVal = results[i]?.away ?? "";

      const div = document.createElement("div");
      div.className = "flex gap-2 items-center mb-2";

      div.innerHTML = `
        <label class="w-32">${f.home}</label>
        <input id="res_home_${i}" type="number" min="0" class="w-12 border p-1 rounded" value="${rhVal}" ${currentPlayer === "david" ? "" : "readonly"} />
        <span>:</span>
        <input id="res_away_${i}" type="number" min="0" class="w-12 border p-1 rounded" value="${raVal}" ${currentPlayer === "david" ? "" : "readonly"} />
        ${currentPlayer === "david" ? `<button class="delete-result-btn bg-red-700 text-white px-2 py-1 rounded ml-2" data-index="${i}" title="Delete result for this fixture">Delete Result</button>` : ""}
      `;
      resultsContainer.appendChild(div);
    });
  }

  function renderPointsPerFixture() {
    pointsPerFixtureContainer.innerHTML = "";
    const fixtures = getFixtures(currentWeek);
    const results = getResults(currentWeek);
    if(fixtures.length === 0 || results.length === 0) {
      pointsPerFixtureContainer.textContent = "Points per fixture will appear here after results are entered.";
      return;
    }

    const header = document.createElement("div");
    header.className = "flex gap-4 font-bold border-b pb-1 mb-2";
    header.innerHTML = `<div class="w-48">Fixture</div>${players.map(p => `<div class="w-20 text-center">${capitalize(p)}</div>`).join("")}`;
    pointsPerFixtureContainer.appendChild(header);

    fixtures.forEach((f,i) => {
      const row = document.createElement("div");
      row.className = "flex gap-4 mb-1 items-center";
      const fixtureText = `${f.home} vs ${f.away}`;
      row.innerHTML = `<div class="w-48">${fixtureText}</div>`;

      players.forEach(p => {
        const preds = getPredictions(currentWeek, p);
        const pred = preds[i];
        const actual = results[i];
        let points = 0;
        if(pred && actual) {
          if(pred.home === actual.home) points++;
          if(pred.away === actual.away) points++;
          const predDiff = pred.home - pred.away;
          const actualDiff = actual.home - actual.away;
          if ((predDiff === 0 && actualDiff === 0) || (predDiff * actualDiff > 0)) points += 2;
          if(pred.home === actual.home && pred.away === actual.away) points++;
        }
        row.innerHTML += `<div class="w-20 text-center">${points}</div>`;
      });
      pointsPerFixtureContainer.appendChild(row);
    });
  }

  function updateLeaderboard() {
    const totalScores = {};
    players.forEach(p => totalScores[p] = 0);

    const weeklyScores = {};

    for(let gw=1; gw<=totalGameWeeks; gw++) {
      const fixtures = getFixtures(gw);
      const results = getResults(gw);
      if(fixtures.length === 0 || results.length === 0) continue;

      weeklyScores[gw] = {};
      players.forEach(p => weeklyScores[gw][p] = 0);

      fixtures.forEach((f, i) => {
        const actual = results[i];
        if(!actual) return;

        players.forEach(p => {
          const preds = getPredictions(gw, p);
          const pred = preds[i];
          if(!pred) return;

          let points = 0;
          if(pred.home === actual.home) points++;
          if(pred.away === actual.away) points++;
          const predDiff = pred.home - pred.away;
          const actualDiff = actual.home - actual.away;
          if ((predDiff === 0 && actualDiff === 0) || (predDiff * actualDiff > 0)) points += 2;
          if(pred.home === actual.home && pred.away === actual.away) points++;
          weeklyScores[gw][p] += points;
          totalScores[p] += points;
        });
      });
    }

    // Weekly leaderboard render
    let weeklyHtml = "<table class='w-full border-collapse'>";
    weeklyHtml += "<thead><tr><th class='border p-1'>Gameweek</th>";
    players.forEach(p => weeklyHtml += `<th class='border p-1'>${capitalize(p)}</th>`);
    weeklyHtml += "</tr></thead><tbody>";
    for(let gw=1; gw<=totalGameWeeks; gw++) {
      weeklyHtml += `<tr><td class='border p-1 text-center'>${gw}</td>`;
      if(weeklyScores[gw]) {
        players.forEach(p => weeklyHtml += `<td class='border p-1 text-center'>${weeklyScores[gw][p]}</td>`);
      } else {
        players.forEach(() => weeklyHtml += `<td class='border p-1 text-center'>-</td>`);
      }
      weeklyHtml += "</tr>";
    }
    weeklyHtml += "</tbody></table>";
    weeklyLeaderboardContainer.innerHTML = weeklyHtml;

    // Overall leaderboard render
    const sortedPlayers = players.slice().sort((a,b) => totalScores[b] - totalScores[a]);
    let overallHtml = "<table class='w-full border-collapse'>";
    overallHtml += "<thead><tr><th class='border p-1'>Rank</th><th class='border p-1'>Player</th><th class='border p-1'>Total Points</th></tr></thead><tbody>";
    sortedPlayers.forEach((p,i) => {
      overallHtml += `<tr><td class='border p-1 text-center'>${i+1}</td><td class='border p-1'>${capitalize(p)}</td><td class='border p-1 text-center'>${totalScores[p]}</td></tr>`;
    });
    overallHtml += "</tbody></table>";
    leaderboardContainer.innerHTML = overallHtml;
  }

  function renderAll() {
    if(!currentPlayer || !currentWeek) {
      predictionsContainer.textContent = "Please select a player and a game week.";
      fixturesContainer.innerHTML = "";
      resultsContainer.innerHTML = "";
      pointsPerFixtureContainer.innerHTML = "";
      deadlineDisplay.textContent = "";
      deadlineInput.value = "";
      leaderboardContainer.textContent = "";
      weeklyLeaderboardContainer.textContent = "";
      return;
    }
    updateControlsVisibility();
    renderDeadline();
    renderFixtures();
    renderPredictions();
    renderResults();
    renderPointsPerFixture();
    updateLeaderboard();
  }

  // Event listeners for game page
  logoutBtn.addEventListener("click", () => {
    currentPlayer = null;
    currentWeek = null;
    loginPlayer.value = "";
    loginPassword.value = "";
    loginMsg.textContent = "";
    gamePage.classList.add("hidden");
    loginPage.classList.remove("hidden");
  });

  gwSelect.addEventListener("change", () => {
    currentWeek = gwSelect.value;
    renderAll();
  });

  addFixtureBtn.addEventListener("click", () => {
    if(currentPlayer !== "david") return;
    const fixtures = getFixtures(currentWeek);
    fixtures.push({home:"", away:""});
    saveFixtures(currentWeek, fixtures);
    renderFixtures();
    renderPredictions();
    renderResults();
  });

  fixturesContainer.addEventListener("click", e => {
    if(e.target.classList.contains("delete-fixture-btn")) {
      if(currentPlayer !== "david") return;
      const idx = +e.target.dataset.index;
      if(!confirm("Delete this fixture? This will also delete associated predictions and results.")) return;

      const fixtures = getFixtures(currentWeek);
      if(idx >= fixtures.length) return;

      fixtures.splice(idx,1);
      saveFixtures(currentWeek, fixtures);

      players.forEach(p => {
        let preds = getPredictions(currentWeek, p);
        if(preds.length > idx) {
          preds.splice(idx, 1);
          savePredictions(currentWeek, p, preds);
        }
      });
      let results = getResults(currentWeek);
      if(results.length > idx) {
        results.splice(idx,1);
        saveResults(currentWeek, results);
      }

      renderFixtures();
      renderPredictions();
      renderResults();
      renderPointsPerFixture();
      updateLeaderboard();
    }
  });

  fixturesContainer.addEventListener("input", e => {
    if(currentPlayer !== "david") return;
    if(!e.target.dataset.index) return;
    if(!currentWeek) return;
    const idx = +e.target.dataset.index;
    const type = e.target.dataset.type;
    const fixtures = getFixtures(currentWeek);
    if(idx >= fixtures.length) return;

    fixtures[idx][type] = e.target.value.trim();
    saveFixtures(currentWeek, fixtures);
    renderPredictions();
  });

  submitPredictionsBtn.addEventListener("click", () => {
    if(!currentPlayer) return alert("Select a player.");
    if(!currentWeek) return alert("Select a game week.");
    const fixtures = getFixtures(currentWeek);
    if(fixtures.length === 0) return alert("Add fixtures first.");

    let predictions = getPredictions(currentWeek, currentPlayer);

    for(let i=0; i<fixtures.length; i++) {
      const resultExists = getResults(currentWeek)[i] !== undefined;
      if(resultExists) continue;

      const homeInput = document.getElementById(`pred_home_${i}`);
      const awayInput = document.getElementById(`pred_away_${i}`);
      if(!homeInput || !awayInput) continue;

      const homeVal = homeInput.value;
      const awayVal = awayInput.value;

      if(homeVal === "" && awayVal === "") continue;

      const homeNum = parseInt(homeVal);
      const awayNum = parseInt(awayVal);
      if(isNaN(homeNum) || isNaN(awayNum)) {
        alert("Please enter valid numbers for predictions.");
        return;
      }

      if(!predictions[i]) predictions[i] = {};
      predictions[i].home = homeNum;
      predictions[i].away = awayNum;
    }

    savePredictions(currentWeek, currentPlayer, predictions);
    alert("Predictions saved!");
    renderPredictions();
    updateLeaderboard();
    renderPointsPerFixture();
  });

  predictionsContainer.addEventListener("click", e => {
    if(e.target.classList.contains("delete-pred-btn")) {
      if(!currentPlayer) return;
      const idx = +e.target.dataset.index;
      const results = getResults(currentWeek);
      if(results[idx] !== undefined) {
        alert("Cannot delete prediction after result has been submitted for this fixture.");
        return;
      }
      let preds = getPredictions(currentWeek, currentPlayer);
      if(preds.length <= idx) return;
      preds.splice(idx, 1);
      savePredictions(currentWeek, currentPlayer, preds);
      renderPredictions();
      updateLeaderboard();
      renderPointsPerFixture();
    }
  });

  submitResultsBtn.addEventListener("click", () => {
    if(currentPlayer !== "david") return alert("Only David can submit results.");
    if(!currentWeek) return alert("Select a game week.");
    const fixtures = getFixtures(currentWeek);
    if(fixtures.length === 0) return alert("Add fixtures first.");

    let results = getResults(currentWeek);

    for(let i=0; i<fixtures.length; i++) {
      const homeInput = document.getElementById(`res_home_${i}`);
      const awayInput = document.getElementById(`res_away_${i}`);
      if(!homeInput || !awayInput) continue;

      const homeVal = homeInput.value;
      const awayVal = awayInput.value;

      if(homeVal === "" && awayVal === "") continue;

      const homeNum = parseInt(homeVal);
      const awayNum = parseInt(awayVal);

      if(isNaN(homeNum) || isNaN(awayNum)) {
        alert("Please enter valid numbers for results.");
        return;
      }

      results[i] = { home: homeNum, away: awayNum };
    }

    saveResults(currentWeek, results);
    alert("Results saved!");
    renderResults();
    renderPointsPerFixture();
    updateLeaderboard();
  });

  resultsContainer.addEventListener("click", e => {
    if(e.target.classList.contains("delete-result-btn")) {
      if(currentPlayer !== "david") return alert("Only David can delete results.");
      const idx = +e.target.dataset.index;
      let results = getResults(currentWeek);
      if(results.length <= idx) return;
      if(!confirm("Delete result for this fixture?")) return;
      results.splice(idx, 1);
      saveResults(currentWeek, results);
      renderResults();
      renderPointsPerFixture();
      updateLeaderboard();
    }
  });

  saveDeadlineBtn.addEventListener("click", () => {
    if(currentPlayer !== "david") return alert("Only David can set deadlines.");
    if(!currentWeek) return alert("Select a game week.");
    if(!deadlineInput.value) return alert("Select a valid deadline date.");
    saveDeadline(currentWeek, deadlineInput.value);
    renderDeadline();
    alert("Deadline saved.");
  });

  exportDataBtn.addEventListener("click", () => {
    if(currentPlayer !== "david") return alert("Only David can export data.");
    const data = {};
    for(let i=0; i<localStorage.length; i++) {
      const key = localStorage.key(i);
      if(key.startsWith("gw_") || key.startsWith("pw_")) {
        data[key] = localStorage.getItem(key);
      }
    }
    const blob = new Blob([JSON.stringify(data, null, 2)], {type: "application/json"});
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = "pl_prediction_backup.json";
    a.click();
    URL.revokeObjectURL(url);
  });

  importDataBtn.addEventListener("click", () => {
    if(currentPlayer !== "david") return alert("Only David can import data.");
    importDataInput.click();
  });

  importDataInput.addEventListener("change", (e) => {
    if(currentPlayer !== "david") return;
    const file = e.target.files[0];
    if(!file) return;
    const reader = new FileReader();
    reader.onload = evt => {
      try {
        const data = JSON.parse(evt.target.result);
        for(let i=localStorage.length-1; i>=0; i--) {
          const key = localStorage.key(i);
          if(key.startsWith("gw_") || key.startsWith("pw_")) {
            localStorage.removeItem(key);
          }
        }
        Object.entries(data).forEach(([k,v]) => localStorage.setItem(k, v));
        alert("Data imported successfully.");
        renderAll();
      } catch {
        alert("Invalid JSON file.");
      }
      importDataInput.value = "";
    };
    reader.readAsText(file);
  });

  // Handle login form submit
  loginForm.addEventListener("submit", e => {
    e.preventDefault();
    const player = loginPlayer.value;
    const pwEntered = loginPassword.value.trim();

    if(!players.includes(player)) {
      loginMsg.textContent = "Invalid player selected.";
      return;
    }
    if(!pwEntered) {
      loginMsg.textContent = "Password cannot be empty.";
      return;
    }

    const storedPw = getPassword(player);

    if(storedPw === null) {
      // No password yet, save it now
      savePassword(player, pwEntered);
      loginMsg.textContent = "";
      loginSuccess(player);
    } else {
      // Check password
      if(storedPw === pwEntered) {
        loginMsg.textContent = "";
        loginSuccess(player);
      } else {
        loginMsg.textContent = "Incorrect password.";
      }
    }
  });

  function loginSuccess(player) {
    currentPlayer = player;
    currentWeek = 1;
    gwSelect.value = currentWeek;
    loginPage.classList.add("hidden");
    gamePage.classList.remove("hidden");
    updateControlsVisibility();
    renderAll();
  }
});
</script>
</body>
</html>
