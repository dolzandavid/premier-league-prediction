<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Premier League Prediction Game</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
    import {
      getFirestore, collection, doc, getDoc, setDoc, updateDoc, getDocs
    } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyA2WG0LUwLCDqmylgezCZ0aH5Q8vTaXTKU",
      authDomain: "pl-predictor-13a6d.firebaseapp.com",
      projectId: "pl-predictor-13a6d",
      storageBucket: "pl-predictor-13a6d.appspot.com",
      messagingSenderId: "286908896536",
      appId: "1:286908896536:web:dabd76b4faaa72a98cfa6d"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    window.firebaseTools = { db, doc, setDoc, getDoc, updateDoc, collection, getDocs };
  </script>
  <style>
    input[type=number]::-webkit-inner-spin-button,
    input[type=number]::-webkit-outer-spin-button {
      -webkit-appearance: none;
      margin: 0;
    }
  </style>
</head>
<body class="bg-gray-100 text-gray-900 p-4">
  <div id="loginPage" class="max-w-md mx-auto mt-10 bg-white shadow p-6 rounded">
    <h1 class="text-2xl font-bold text-center mb-4">Premier League Predictor</h1>
    <form id="loginForm" class="space-y-4">
      <div>
        <label for="loginPlayer" class="block font-semibold mb-1">Select Player:</label>
        <select id="loginPlayer" required class="w-full p-2 border rounded">
          <option value="" disabled selected>Select</option>
          <option value="david">David</option>
          <option value="katja">Katja</option>
          <option value="mark">Mark</option>
          <option value="jus">Jus</option>
        </select>
      </div>
      <div>
        <label for="loginPassword" class="block font-semibold mb-1">Password:</label>
        <input type="password" id="loginPassword" required class="w-full p-2 border rounded" />
      </div>
      <p id="loginError" class="text-red-600 text-sm"></p>
      <button class="bg-blue-600 text-white w-full py-2 rounded hover:bg-blue-700">Login</button>
      <button type="button" id="showResetBtn" class="text-sm mt-2 underline text-blue-700 hover:text-blue-900">Forgot or Reset Password?</button>
    </form>

    <form id="resetForm" class="space-y-3 mt-6 hidden">
      <h2 class="font-bold text-center mb-2">Reset Password</h2>
      <select id="resetPlayer" required class="w-full p-2 border rounded">
        <option value="" disabled selected>Select</option>
        <option value="david">David</option>
        <option value="katja">Katja</option>
        <option value="mark">Mark</option>
        <option value="jus">Jus</option>
      </select>
      <input type="password" id="currentPassword" placeholder="Current password" required class="w-full p-2 border rounded" />
      <input type="password" id="newPassword" placeholder="New password" required class="w-full p-2 border rounded" />
      <input type="password" id="confirmPassword" placeholder="Confirm new password" required class="w-full p-2 border rounded" />
      <p id="resetMsg" class="text-red-600 text-sm text-center"></p>
      <button class="bg-green-600 text-white w-full py-2 rounded hover:bg-green-700">Reset</button>
      <button type="button" id="cancelResetBtn" class="w-full text-sm underline text-red-700 mt-2 hover:text-red-900">Cancel</button>
    </form>
  </div>

  <div id="gamePage" class="max-w-5xl mx-auto hidden">
    <div class="flex justify-between items-center mb-4">
      <h1 class="text-2xl font-bold">Premier League Prediction Game</h1>
      <button id="logoutBtn" class="bg-red-600 text-white px-4 py-2 rounded">Logout</button>
    </div>
    <!-- Game Week -->
    <div class="mb-4">
      <label for="gameWeek" class="font-semibold">Game Week:</label>
      <select id="gameWeek" class="ml-2 p-1 border rounded"></select>
    </div>

    <!-- Deadline Section -->
    <div class="mb-4">
      <label class="font-semibold">Deadline:</label>
      <span id="deadlineDisplay" class="ml-2"></span>
      <input type="date" id="deadlineInput" class="ml-2 p-1 border rounded hidden" />
      <button id="saveDeadlineBtn" class="ml-2 bg-blue-600 text-white px-3 py-1 rounded hidden">Save Deadline</button>
    </div>

    <!-- Fixtures (David only) -->
    <div class="mb-6" id="fixturesSection">
      <h2 class="text-xl font-semibold mb-2">Fixtures</h2>
      <button id="addFixture" class="mb-2 bg-blue-500 text-white px-2 py-1 rounded hidden">Add Fixture</button>
      <div id="fixtures"></div>
    </div>

    <!-- Predictions -->
    <div class="mb-6">
      <h2 class="text-xl font-semibold mb-2">Your Predictions</h2>
      <div id="predictions"></div>
    </div>
    <button id="submitPredictions" class="mb-6 bg-green-500 text-white px-4 py-2 rounded">Submit Predictions</button>

    <!-- Results Input -->
    <div class="mb-6">
      <h2 class="text-xl font-semibold mb-2">Actual Results</h2>
      <div id="results"></div>
      <button id="submitResults" class="mt-2 bg-purple-500 text-white px-4 py-2 rounded hidden">Submit Results</button>
    </div>

    <!-- Points per Fixture -->
    <div class="mb-6">
      <h2 class="text-xl font-semibold mb-2">Points per Fixture</h2>
      <div id="pointsPerFixture"></div>
    </div>

    <!-- Leaderboards -->
    <div class="mb-6">
      <h2 class="text-xl font-semibold mb-2">Weekly Leaderboard</h2>
      <div id="weeklyLeaderboard" class="bg-white p-4 rounded shadow mb-4"></div>
      <h2 class="text-xl font-semibold mb-2">Overall Leaderboard</h2>
      <div id="leaderboard" class="bg-white p-4 rounded shadow"></div>
    </div>

    <!-- Backup (David only) -->
    <div id="dataBackup" class="mb-6 hidden">
      <h2 class="text-xl font-semibold mb-2">Data Backup (David only)</h2>
      <button id="exportDataBtn" class="bg-yellow-500 text-black px-4 py-2 rounded mr-4">Export Data</button>
      <input type="file" id="importDataInput" accept=".json" class="hidden" />
      <button id="importDataBtn" class="bg-yellow-500 text-black px-4 py-2 rounded">Import Data</button>
    </div>
  </div>

  <script type="module">
    import { db, doc, setDoc, getDoc, updateDoc, collection, getDocs } from "./firebase.js";

    const players = ["david", "katja", "mark", "jus"];
    const totalGameWeeks = 38;
  </script>
</body>
</html>

  // Firebase read functions
  async function fetchFixtures(gw) {
    const doc = await getDoc(doc(db, "fixtures", `gw${gw}`));
    return doc.exists() ? doc.data().data : [];
  }

  async function fetchPredictions(gw, player) {
    const doc = await getDoc(doc(db, "predictions", `gw${gw}_${player}`));
    return doc.exists() ? doc.data().data : [];
  }

  async function fetchResults(gw) {
    const doc = await getDoc(doc(db, "results", `gw${gw}`));
    return doc.exists() ? doc.data().data : [];
  }

  async function fetchDeadline(gw) {
    const doc = await getDoc(doc(db, "deadlines", `gw${gw}`));
    return doc.exists() ? doc.data().date : "";
  }

  async function fetchPassword(player) {
    const doc = await getDoc(doc(db, "passwords", player));
    return doc.exists() ? doc.data().pw : null;
  }

  // Firebase write functions
  async function saveFixtures(gw, fixtures) {
    await setDoc(doc(db, "fixtures", `gw${gw}`), { data: fixtures });
  }

  async function savePredictions(gw, player, preds) {
    await setDoc(doc(db, "predictions", `gw${gw}_${player}`), { data: preds });
  }

  async function saveResults(gw, results) {
    await setDoc(doc(db, "results", `gw${gw}`), { data: results });
  }

  async function saveDeadline(gw, dateStr) {
    await setDoc(doc(db, "deadlines", `gw${gw}`), { date: dateStr });
  }

  async function savePassword(player, pw) {
    await setDoc(doc(db, "passwords", player), { pw });
  }

  async function deletePrediction(gw, player, index) {
    const data = await fetchPredictions(gw, player);
    data.splice(index, 1);
    await savePredictions(gw, player, data);
  }

  async function deleteResult(gw, index) {
    const data = await fetchResults(gw);
    data.splice(index, 1);
    await saveResults(gw, data);
  }

  async function deleteFixture(gw, index) {
    const fixtures = await fetchFixtures(gw);
    if (index < fixtures.length) {
      fixtures.splice(index, 1);
      await saveFixtures(gw, fixtures);
    }

    for (const p of players) {
      const preds = await fetchPredictions(gw, p);
      if (index < preds.length) {
        preds.splice(index, 1);
        await savePredictions(gw, p, preds);
      }
    }

    const results = await fetchResults(gw);
    if (index < results.length) {
      results.splice(index, 1);
      await saveResults(gw, results);
    }
  }
  // Event bindings and initial logic
  loginForm.addEventListener("submit", async (e) => {
    e.preventDefault();
    const player = loginPlayer.value;
    const pwEntered = loginPassword.value.trim();

    const storedPw = await fetchPassword(player);

    if (storedPw === null) {
      await savePassword(player, pwEntered);
      login(player);
    } else if (storedPw === pwEntered) {
      login(player);
    } else {
      loginMsg.textContent = "Incorrect password.";
    }
  });

  resetForm.addEventListener("submit", async (e) => {
    e.preventDefault();
    const player = resetPlayer.value;
    const currentPwVal = currentPassword.value.trim();
    const newPwVal = newPassword.value.trim();
    const confirmPwVal = confirmPassword.value.trim();

    if (newPwVal !== confirmPwVal) {
      resetMsg.textContent = "New passwords do not match.";
      return;
    }

    const storedPw = await fetchPassword(player);
    if (storedPw === currentPwVal) {
      await savePassword(player, newPwVal);
      resetMsg.style.color = "green";
      resetMsg.textContent = "Password reset successful!";
    } else {
      resetMsg.textContent = "Current password incorrect.";
    }
  });

  function login(player) {
    currentPlayer = player;
    loginPage.classList.add("hidden");
    gamePage.classList.remove("hidden");
    renderAll();
  }

  logoutBtn.addEventListener("click", () => {
    location.reload();
  });

  gwSelect.addEventListener("change", () => {
    currentWeek = parseInt(gwSelect.value);
    renderAll();
  });

  async function renderAll() {
    currentWeek = parseInt(gwSelect.value) || 1;
    updateControlsVisibility();

    const fixtures = await fetchFixtures(currentWeek);
    const results = await fetchResults(currentWeek);
    const deadline = await fetchDeadline(currentWeek);

    // Render deadline
    deadlineDisplay.textContent = deadline || "None";
    deadlineInput.value = deadline;

    // Render fixtures
    fixturesContainer.innerHTML = "";
    fixtures.forEach((f, i) => {
      const div = document.createElement("div");
      div.className = "mb-2 flex gap-2";
      div.innerHTML = `
        <input class="border p-1" data-type="home" data-index="${i}" value="${f.home}">
        vs
        <input class="border p-1" data-type="away" data-index="${i}" value="${f.away}">
        ${currentPlayer === "david" ? `<button class="delete-fixture-btn" data-index="${i}">❌</button>` : ""}
      `;
      fixturesContainer.appendChild(div);
    });

    // Render predictions
    const predictions = await fetchPredictions(currentWeek, currentPlayer);
    predictionsContainer.innerHTML = "";
    fixtures.forEach((f, i) => {
      const pred = predictions[i] || {};
      predictionsContainer.innerHTML += `
        <div class="mb-2">
          <label>${f.home}</label>
          <input id="pred_home_${i}" type="number" class="w-12" value="${pred.home ?? ""}">
          :
          <input id="pred_away_${i}" type="number" class="w-12" value="${pred.away ?? ""}">
          <label>${f.away}</label>
        </div>
      `;
    });

    // Render results
    resultsContainer.innerHTML = "";
    fixtures.forEach((f, i) => {
      const res = results[i] || {};
      resultsContainer.innerHTML += `
        <div class="mb-2">
          <label>${f.home}</label>
          <input id="res_home_${i}" type="number" class="w-12" value="${res.home ?? ""}">
          :
          <input id="res_away_${i}" type="number" class="w-12" value="${res.away ?? ""}">
          <label>${f.away}</label>
        </div>
      `;
    });
  }

  saveDeadlineBtn.addEventListener("click", async () => {
    await saveDeadline(currentWeek, deadlineInput.value);
    alert("Deadline saved.");
    renderAll();
  });

  addFixtureBtn.addEventListener("click", async () => {
    const fixtures = await fetchFixtures(currentWeek);
    fixtures.push({ home: "", away: "" });
    await saveFixtures(currentWeek, fixtures);
    renderAll();
  });

  fixturesContainer.addEventListener("input", async (e) => {
    const type = e.target.dataset.type;
    const index = e.target.dataset.index;
    if (type && index !== undefined) {
      const fixtures = await fetchFixtures(currentWeek);
      fixtures[index][type] = e.target.value;
      await saveFixtures(currentWeek, fixtures);
    }
  });

  fixturesContainer.addEventListener("click", async (e) => {
    if (e.target.classList.contains("delete-fixture-btn")) {
      const index = parseInt(e.target.dataset.index);
      await deleteFixture(currentWeek, index);
      renderAll();
    }
  });

  submitPredictionsBtn.addEventListener("click", async () => {
    const fixtures = await fetchFixtures(currentWeek);
    const predictions = [];
    for (let i = 0; i < fixtures.length; i++) {
      const h = document.getElementById(`pred_home_${i}`)?.value;
      const a = document.getElementById(`pred_away_${i}`)?.value;
      if (h !== "" && a !== "") predictions[i] = { home: +h, away: +a };
    }
    await savePredictions(currentWeek, currentPlayer, predictions);
    alert("Predictions saved.");
  });

  submitResultsBtn.addEventListener("click", async () => {
    const fixtures = await fetchFixtures(currentWeek);
    const results = [];
    for (let i = 0; i < fixtures.length; i++) {
      const h = document.getElementById(`res_home_${i}`)?.value;
      const a = document.getElementById(`res_away_${i}`)?.value;
      if (h !== "" && a !== "") results[i] = { home: +h, away: +a };
    }
    await saveResults(currentWeek, results);
    alert("Results saved.");
    renderAll();
  });

  // Initialize
  for (let i = 1; i <= 38; i++) {
    const opt = document.createElement("option");
    opt.value = i;
    opt.textContent = `Gameweek ${i}`;
    gwSelect.appendChild(opt);
  }
  gwSelect.value = 1;
  currentWeek = 1;
});
</script>
</body>
</html>
